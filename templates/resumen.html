<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>üìä Dashboard de Ventas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Favicon para navegadores -->
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='favicon-16x16.png') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">

    <!-- Apple y Android -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='apple-touch-icon.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='site.webmanifest') }}">

    <!-- Android iconos -->
    <link rel="icon" sizes="192x192" href="{{ url_for('static', filename='android-chrome-192x192.png') }}">
    <link rel="icon" sizes="512x512" href="{{ url_for('static', filename='android-chrome-512x512.png') }}">

</head>
<body class="bg-light p-4">

<div class="container">
    <h1 class="mb-4 text-center">üìä Dashboard de Ventas por Sucursal</h1>

    <!-- üè™ Selector de sucursal -->
    <form method="POST" class="mb-4 text-center">
        <label for="sucursal" class="form-label">Sucursal:</label>
        <select name="sucursal" id="sucursal" class="form-select w-auto d-inline-block" onchange="this.form.submit()">
            {% for s in sucursales %}
                <option value="{{ s }}" {% if s == sucursal_actual %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
        </select>
        <a href="/" class="btn btn-secondary ms-2">‚¨Ö Volver al inicio</a>
    </form>

    <!-- üìä Men√∫ de tipo de gr√°fica -->
    <div class="mb-4 text-center">
        <label for="tipoGrafica" class="form-label">Selecciona la comparaci√≥n:</label>
        <select id="tipoGrafica" class="form-select w-auto d-inline-block" onchange="mostrarGrafica()">
            <option value="general" selected>Comparaci√≥n General</option>
            <option value="plataformas">Comparaci√≥n de Plataformas</option>
            <option value="areas">Comparaci√≥n de √Åreas</option>
            <option value="global">Comparaci√≥n entre Sucursales</option>
        </select>
    </div>

    <!-- üìà Comparaci√≥n General -->
    <div id="contenedor-general" style="display:block;">
        <h4 class="mt-4 text-center">üìà Comparaci√≥n General</h4>
        <canvas id="graficaGeneral"></canvas>
    </div>

    <!-- üíª Comparaci√≥n de Plataformas -->
    <div id="contenedor-plataformas" style="display:none;">
        <h4 class="mt-4 text-center">üíª Plataformas</h4>
        <div class="row">
            <div class="col-md-6">
                <h5 class="text-center">üí∞ Ventas</h5>
                <canvas id="graficaPlataformasVentas"></canvas>
            </div>
            <div class="col-md-6">
                <h5 class="text-center">üì¶ Pedidos</h5>
                <canvas id="graficaPlataformasPedidos"></canvas>
            </div>
        </div>
    </div>

    <!-- üè™ Comparaci√≥n de √Åreas -->
    <div id="contenedor-areas" style="display:none;">
        <h4 class="mt-4 text-center">üè™ √Åreas</h4>
        <div class="row">
            <div class="col-md-6">
                <h5 class="text-center">üí∞ Ventas</h5>
                <canvas id="graficaAreasVentas"></canvas>
            </div>
            <div class="col-md-6">
                <h5 class="text-center">üë• Cuentas</h5>
                <canvas id="graficaAreasCuentas"></canvas>
            </div>
        </div>
    </div>

    <!-- üåé Comparaci√≥n Global -->
    <div id="contenedor-global" style="display:none;">
        <h4 class="mt-4 text-center">üåé Comparaci√≥n entre Sucursales</h4>
        <div class="row">
            <div class="col-md-6">
                <h5 class="text-center">üí∞ Total Sucursal</h5>
                <canvas id="graficaTotalSucursal"></canvas>
            </div>
            <div class="col-md-6">
                <h5 class="text-center">üìä Ticket Promedio</h5>
                <canvas id="graficaTicketPromedio"></canvas>
            </div>
        </div>
    </div>

    <!-- üìä Tabla de datos -->
    <hr class="my-4">
    <h4 class="mb-3">üìã Tabla de datos</h4>
    <div class="table-responsive">
        <table class="table table-striped table-bordered text-center align-middle">
            <thead class="table-dark">
                {% if data|length > 0 %}
                <tr>
                    {% for col in data[0].keys() %}
                    <th>{{ col }}</th>
                    {% endfor %}
                </tr>
                {% else %}
                <tr><td colspan="20" class="text-center">‚ö†Ô∏è No hay datos disponibles para esta sucursal.</td></tr>
                {% endif %}
            </thead>
            <tbody>
                {% for fila in data %}
                <tr>
                    {% for valor in fila.values() %}
                    <td>{{ valor }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ================== üß† SCRIPT CONTROL DE VISTA ================== -->
<script>
function mostrarGrafica() {
    const tipo = document.getElementById('tipoGrafica').value;
    document.getElementById('contenedor-general').style.display = (tipo === 'general') ? 'block' : 'none';
    document.getElementById('contenedor-plataformas').style.display = (tipo === 'plataformas') ? 'block' : 'none';
    document.getElementById('contenedor-areas').style.display = (tipo === 'areas') ? 'block' : 'none';
    document.getElementById('contenedor-global').style.display = (tipo === 'global') ? 'block' : 'none';
}
</script>

<!-- ================== üìà SCRIPT DE GR√ÅFICAS ================== -->
<script>
let sucursalSeleccionada = "{{ sucursal_actual }}";
let chartGeneral, chartPlataformasVentas, chartPlataformasPedidos, chartAreasVentas, chartAreasCuentas;
let chartGlobalTotales, chartGlobalTicket;

const colores = {
    uber: 'red',
    didi: 'blue',
    rappi: 'green',
    comedor: 'orange',
    domicilio: 'purple',
    rapido: 'brown'
};

async function cargarDatos() {
    const res = await fetch(`/datos_grafica/${encodeURIComponent(sucursalSeleccionada)}`);
    const data = await res.json();
    generarGraficaGeneral(data);
    generarGraficaPlataformas(data);
    generarGraficaAreas(data);
    await cargarDatosGlobal();
}

// üìà Gr√°fica General
function generarGraficaGeneral(data) {
    if (chartGeneral) chartGeneral.destroy();
    chartGeneral = new Chart(document.getElementById('graficaGeneral').getContext('2d'), {
        type: 'line',
        data: {
            labels: data.meses,
            datasets: [
                { label: 'UBER', data: data.uber, borderColor: colores.uber, borderWidth: 2, tension: 0.3 },
                { label: 'DIDI', data: data.didi, borderColor: colores.didi, borderWidth: 2, tension: 0.3 },
                { label: 'RAPPI', data: data.rappi, borderColor: colores.rappi, borderWidth: 2, tension: 0.3 },
                { label: 'COMEDOR', data: data.comedor, borderColor: colores.comedor, borderWidth: 2, tension: 0.3 },
                { label: 'DOMICILIO', data: data.domicilio, borderColor: colores.domicilio, borderWidth: 2, tension: 0.3 },
                { label: 'R√ÅPIDO', data: data.rapido, borderColor: colores.rapido, borderWidth: 2, tension: 0.3 },
            ]
        },
        options: { responsive: true, plugins: { legend: { position: 'top' } } }
    });
}

// üíª Plataformas
function generarGraficaPlataformas(data) {
    if (chartPlataformasVentas) chartPlataformasVentas.destroy();
    chartPlataformasVentas = new Chart(document.getElementById('graficaPlataformasVentas').getContext('2d'), {
        type: 'line',
        data: {
            labels: data.meses,
            datasets: [
                { label: 'UBER', data: data.uber, borderColor: colores.uber, borderWidth: 2, tension: 0.3, pointRadius: 4 },
                { label: 'DIDI', data: data.didi, borderColor: colores.didi, borderWidth: 2, tension: 0.3, pointRadius: 4 },
                { label: 'RAPPI', data: data.rappi, borderColor: colores.rappi, borderWidth: 2, tension: 0.3, pointRadius: 4 },
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'top' } },
            scales: { y: { beginAtZero: true } }
        }
    });

    if (chartPlataformasPedidos) chartPlataformasPedidos.destroy();
    chartPlataformasPedidos = new Chart(document.getElementById('graficaPlataformasPedidos').getContext('2d'), {
        type: 'line',
        data: {
            labels: data.meses,
            datasets: [
                { label: 'PEDIDOS UBER', data: data.pedidos_uber, borderColor: colores.uber, borderWidth: 2, tension: 0.3, pointRadius: 4 },
                { label: 'PEDIDOS DIDI', data: data.pedidos_didi, borderColor: colores.didi, borderWidth: 2, tension: 0.3, pointRadius: 4 },
                { label: 'PEDIDOS RAPPI', data: data.pedidos_rappi, borderColor: colores.rappi, borderWidth: 2, tension: 0.3, pointRadius: 4 },
            ]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'top' } },
            scales: { y: { beginAtZero: true } }
        }
    });
}

// üè™ √Åreas
function generarGraficaAreas(data) {
    if (chartAreasVentas) chartAreasVentas.destroy();
    chartAreasVentas = new Chart(document.getElementById('graficaAreasVentas').getContext('2d'), {
        type: 'line',
        data: {
            labels: data.meses,
            datasets: [
                { label: 'COMEDOR', data: data.comedor, borderColor: colores.comedor, borderWidth: 2, tension: 0.3 },
                { label: 'DOMICILIO', data: data.domicilio, borderColor: colores.domicilio, borderWidth: 2, tension: 0.3 },
                { label: 'R√ÅPIDO', data: data.rapido, borderColor: colores.rapido, borderWidth: 2, tension: 0.3 },
            ]
        }
    });

    if (chartAreasCuentas) chartAreasCuentas.destroy();
    chartAreasCuentas = new Chart(document.getElementById('graficaAreasCuentas').getContext('2d'), {
        type: 'line',
        data: {
            labels: data.meses,
            datasets: [
                { label: 'CUENTAS COMEDOR', data: data.cuentas_comedor, borderColor: colores.comedor, borderWidth: 2, tension: 0.3 },
                { label: 'CUENTAS DOMICILIO', data: data.cuentas_domicilio, borderColor: colores.domicilio, borderWidth: 2, tension: 0.3 },
                { label: 'CUENTAS R√ÅPIDO', data: data.cuentas_rapido, borderColor: colores.rapido, borderWidth: 2, tension: 0.3 },
            ]
        }
    });
}

// üåé Global
async function cargarDatosGlobal() {
    const res = await fetch(`/datos_grafica_global`);
    const data = await res.json();
    generarGraficaGlobal(data);
}

function generarGraficaGlobal(data) {
    if (chartGlobalTotales) chartGlobalTotales.destroy();
    chartGlobalTotales = new Chart(document.getElementById('graficaTotalSucursal').getContext('2d'), {
        type: 'bar',
        data: {
            labels: data.sucursales,
            datasets: [{
                label: 'Total Sucursal',
                data: data.totales,
                backgroundColor: 'orange'
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });

    if (chartGlobalTicket) chartGlobalTicket.destroy();
    chartGlobalTicket = new Chart(document.getElementById('graficaTicketPromedio').getContext('2d'), {
        type: 'bar',
        data: {
            labels: data.sucursales,
            datasets: [{
                label: 'Ticket Promedio',
                data: data.ticket_promedio,
                backgroundColor: 'green'
            }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
    });
}

cargarDatos();
</script>

</body>
</html>
