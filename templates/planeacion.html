<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Planeación - La Postal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="static/css/planeacion.css">
</head>

<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('home') }}">
                LA POSTAL | PLANEACIÓN
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    Hola, <span style="color: #b71c1c; font-weight: 500;" id="nombreUsuario">{{ current_user.nombre
                        }}</span>
                </span>
                <a class="nav-link" href="{{ url_for('home') }}">Dashboard</a>
                <a class="nav-link" href="{{ url_for('perfil') }}">Perfil</a>
                <a class="nav-link" href="{{ url_for('logout') }}">Salir</a>
            </div>
        </div>
    </nav>

    <!-- ENCABEZADO CORPORATIVO -->
    <div class="corporate-header">
        <div class="container">
            <div class="header-logo">LA POSTAL</div>
            <div class="header-subtitle">Sistema de Gestión de Actividades</div>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="main-container">
        <!-- TARJETAS RESUMEN -->
        <div class="row summary-cards g-3 mt-0">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="summary-card sales" onclick="generarReporte('vigentes')" style="cursor: pointer;">
                        <div class="card-number" id="contadorVigentes">0</div>
                        <div class="card-label">VIGENTES</div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="summary-card customers" onclick="generarReporte('vencidos')" style="cursor: pointer;">
                        <div class="card-number" id="contadorVencidos">0</div>
                        <div class="card-label">VENCIDOS</div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="summary-card average" onclick="generarReporte('en-tramite')" style="cursor: pointer;">
                        <div class="card-number" id="contadorTramite">0</div>
                        <div class="card-label">EN TRÁMITE</div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="summary-card target" onclick="generarReporte('pendientes')" style="cursor: pointer;">
                        <div class="card-number" id="contadorPendientes">0</div>
                        <div class="card-label">PENDIENTES</div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="summary-card" style="--card-color: #9c27b0; cursor: pointer;"
                        onclick="generarReporte('proximos-a-vencer')">
                        <div class="card-number" id="contadorProximos">0</div>
                        <div class="card-label">PRÓXIMOS A VENCER</div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="summary-card" style="--card-color: #607d8b; cursor: pointer;"
                        onclick="generarReporte('todos')">
                        <div class="card-number" id="contadorTotal">0</div>
                        <div class="card-label">TOTAL</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTROLES DE VISTA -->
        <div class="view-controls">
            <h6 class="mb-3" style="color: #aaa;">EJEMPLO</h6>
            <div class="d-flex flex-wrap">
                <button class="view-btn active" id="btnVistaTabla">
                    <span class="kanji-header" style="font-size: 0.9rem;">板</span> Tabla
                </button>
                <button class="view-btn" id="btnVistaKanban">
                    <span class="kanji-header" style="font-size: 0.7rem;">看板</span> Kanban
                </button>
            </div>
        </div>

        <!-- ÁREA DE FILTROS -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">Bloque:</label>
                    <select class="filter-select" id="blockFilter">
                        <option value="all">Todas las Sucursales</option>
                        <option value="1">Bloque 1</option>
                        <option value="2">Bloque 2</option>
                        <option value="3">Bloque 3</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Sucursales:</label>
                    <select class="filter-select" id="branchFilter">
                        <option value="all">Todas las Sucursales</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Permiso:</label>
                    <select class="filter-select" id="permisoFilter">
                        <option value="all">Todos</option>
                        <option>Anuncios</option>
                        <option>Atrapa la grasa</option>
                        <option>Basura</option>
                        <option>Bomberos</option>
                        <option>Cofepris</option>
                        <option>Dictamen de gas</option>
                        <option>Dictamen termografico</option>
                        <option>Impacto de anuencia ambiental</option>
                        <option>Linea Amarilla</option>
                        <option>Operaciones</option>
                        <option>Plano</option>
                        <option>Residuos solidos urbanos (RSU)</option>
                        <option>Uso de suelo</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Estatus:</label>
                    <select class="filter-select" id="estatusFilter">
                        <option value="all">Todos</option>
                        <option value="vigente">Vigente</option>
                        <option value="en-tramite">En trámite</option>
                        <option value="vencido">Vencido</option>
                        <option value="pendiente">Pendiente</option>
                    </select>
                </div>
                <div class="search-box">
                    <label class="filter-label">Búsqueda Avanzada</label>
                    <input type="text" class="search-input" id="busquedaInput"
                        placeholder="Buscar por producto, código, descripción...">
                </div>
            </div>
        </div>

        <!-- SEPARADOR -->
        <div class="section-divider"></div>

        <!-- TABLA DE DATOS -->
        <div class="data-table-container" id="tablaContainer">
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">BLOQUE</th>
                            <th style="width: 20%;">SUCURSAL</th>
                            <th style="width: 10%;">PERMISO</th>
                            <th style="width: 10%;">EXISTENCIA</th>
                            <th style="width: 10%;">ESTATUS</th>
                            <th style="width: 10%;">FECHA EXPEDICION</th>
                            <th style="width: 10%;">FECHA RENOVACION</th>
                            <th style="width: 10%;">ESTATUS LEGAL</th>
                            <th style="width: 10%;">PERMISO LEGAL</th>
                            <th style="width: 15%;">PERMISO DIGITAL</th>
                            <th style="width: 15%;">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody id="tablaBody"></tbody>
                </table>
            </div>

            <!-- PIE DE TABLA -->
            <div style="padding: 1rem 1.5rem; background-color: #1a1a1a; border-top: 1px solid var(--color-border);">
                <div class="d-flex justify-content-between align-items-center">
                    <div style="color: #aaa; font-size: 0.9rem;">
                        Mostrando <span id="contadorRegistros">0</span> registros
                    </div>
                    <div>
                        <button id="btnAgregar" class="btn-secondary-custom">
                            <i class="fas fa-plus me-1"></i> Agregar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENEDOR KANBAN -->
        <div id="kanbanContainer" class="data-table-container" style="display: none;">
            <div id="kanbanView" class="kanban-view"></div>
        </div>

        <!-- MODAL VER DETALLES -->
        <div id="modalDetalle" class="modal-overlay">
            <div class="modal-box" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 id="modalDetalleTitulo" style="margin: 0; font-size: 1.3rem;">Detalles del Permiso</h3>
                </div>
                <div class="modal-body">
                    <div id="detalleContenido"></div>
                </div>
                <div class="modal-footer">
                    <button id="editarDesdeDetalle" class="btn-primary-custom" style="margin-right: 0.5rem;">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL AGREGAR REGISTRO -->
        <div id="modalAgregar" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-header">
                    <h3 id="modalTitulo" style="margin: 0; font-size: 1.3rem;">Agregar Permiso</h3>
                </div>
                <div class="modal-body">
                    <div class="form-grid">
                        <div>
                            <label>Asigna</label>
                            <select id="asigna">
                                <option value="">Seleccionar</option>
                                <option>Christian M</option>
                                <option>Antonio S</option>
                                <option>Omar R</option>
                            </select>
                        </div>
                        <div>
                            <label>Bloque</label>
                            <select id="bloqueModal"></select>
                        </div>
                        <div>
                            <label>Sucursal</label>
                            <select id="sucursalModal"></select>
                        </div>
                        <div>
                            <label>Permiso</label>
                            <select id="permiso">
                                <option>Anuncios</option>
                                <option>Atrapa la grasa</option>
                                <option>Basura</option>
                                <option>Bomberos</option>
                                <option>Cofepris</option>
                                <option>Dictamen de gas</option>
                                <option>Dictamen termografico</option>
                                <option>Impacto de anuencia ambiental</option>
                                <option>Linea Amarilla</option>
                                <option>Operaciones</option>
                                <option>Plano</option>
                                <option>Residuos solidos urbanos (RSU)</option>
                                <option>Uso de suelo</option>
                            </select>
                        </div>
                        <div>
                            <label>Existencia</label>
                            <select id="existencia">
                                <option>Recibo</option>
                                <option>Recibo N/T</option>
                                <option>Licencia</option>
                                <option>Licencia N/T</option>
                            </select>
                        </div>
                        <div>
                            <label>Estatus</label>
                            <select id="estatus">
                                <option value="vigente">Vigente</option>
                                <option value="en-tramite">En trámite</option>
                                <option value="vencido">Vencido</option>
                                <option value="pendiente">Pendiente</option>
                            </select>
                        </div>
                        <div>
                            <label>Fecha Expedición</label>
                            <input type="date" id="fechaExpedicion">
                        </div>
                        <div>
                            <label>Fecha Renovación</label>
                            <input type="date" id="fechaRenovacion">
                        </div>
                        <div>
                            <label>Estatus Legal</label>
                            <select id="estatusLegal">
                                <option>✓</option>
                                <option>Dependencia a otro permiso</option>
                                <option>En espera de legal</option>
                                <option>En espero de permiso</option>
                                <option>Falta pago</option>
                                <option>Faltan Modificaciones</option>
                                <option>Modificaciones</option>
                                <option>Primer pago</option>
                                <option>Segundo Pago</option>
                            </select>
                        </div>
                        <div>
                            <label>Documento Digital</label>
                            <input type="file" id="permisoDigital" accept="*/*">
                            <div class="file-info" id="fileInfo"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="cancelarModal" class="btn-secondary-custom">Cancelar</button>
                    <button id="guardarRegistro" class="btn-primary-custom">Guardar</button>
                </div>
            </div>
        </div>

        <!-- MODAL REPORTES -->
        <div class="modal fade" id="reporteModal" tabindex="-1" aria-labelledby="reporteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="text-center py-5" id="modalLoading">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-3">Generando reporte...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // CONFIGURACIÓN SUPABASE
        const SUPABASE_URL = 'https://uooffrtjajluvhcauctk.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVvb2ZmcnRqYWpsdXZoY2F1Y3RrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMTI5OTUsImV4cCI6MjA4MTU4ODk5NX0.SLhTDpScIaoCbjd_VDRGYyTj5lR6drtsfGXNJXThpz8';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DATOS Y VARIABLES GLOBALES
        const branchData = [
            { name: "5 Y 10", block: "3" }, { name: "ALEMÁN", block: "3" },
            { name: "BRISAS", block: "1" }, { name: "CACHO", block: "1" },
            { name: "CALIFORNIAS", block: "3" }, { name: "CAMPESTRE MURUA", block: "3" },
            { name: "CAMPIÑA", block: "3" }, { name: "CAPISTRANO", block: "3" },
            { name: "COLINA AZUL", block: "3" }, { name: "DARUMMITA LIBERTAD", block: "3" },
            { name: "DARUMMITA PLAYAS", block: "2" }, { name: "ENSENADA", block: "1" },
            { name: "FLORIDO", block: "3" }, { name: "INDEPENDENCIA", block: "3" },
            { name: "LAGO", block: "3" }, { name: "LIBERTAD", block: "3" },
            { name: "MALECÓN", block: "3" }, { name: "MALECÓN 2", block: "3" },
            { name: "MARIANO MATAMOROS", block: "3" }, { name: "MATRIZ", block: "1" },
            { name: "MURUA", block: "3" }, { name: "PANAMERICANO", block: "3" },
            { name: "PLAYAS 1", block: "1" }, { name: "ROSARITO 3", block: "2" },
            { name: "SOLER", block: "3" }, { name: "TORRES", block: "1" },
            { name: "VENECIA", block: "3" }, { name: "ZONA NORTE", block: "3" },
            { name: "ZONA RÍO", block: "3" }
        ];

        // Iconos para archivos
        const fileIcons = {
            'pdf': 'fa-file-pdf',
            'doc': 'fa-file-word',
            'docx': 'fa-file-word',
            'xls': 'fa-file-excel',
            'xlsx': 'fa-file-excel',
            'jpg': 'fa-file-image',
            'jpeg': 'fa-file-image',
            'png': 'fa-file-image',
            'txt': 'fa-file-alt',
            'zip': 'fa-file-archive',
            'rar': 'fa-file-archive',
            'default': 'fa-file'
        };

        let permisosGuardados = [];
        let editingIndex = -1;
        let currentView = 'tabla';
        let reporteActual = '';

        // =========================
        // UTILIDADES
        // =========================
        function getFileIcon(filename) {
            if (!filename) return fileIcons.default;
            const extension = filename.split('.').pop().toLowerCase();
            return fileIcons[extension] || fileIcons.default;
        }

        function normalizarTxt(x) {
            return (x ?? '').toString().trim();
        }

        // =========================
        // CARGA PRINCIPAL (SIN ARCHIVE_DATA)
        // =========================
        async function cargarDatosIniciales() {
            console.log('Cargando datos desde Supabase...');

            // IMPORTANTE: NO TRAER archive_data EN LISTADO
            const { data, error } = await supabaseClient
                .from('datos_financieros')
                .select(`
        id,
        anexa,
        bloque,
        sucursal,
        tipo_permiso,
        existencia,
        estatus,
        fecha_expedicion,
        fecha_renovacion,
        estatus_legal,
        permiso_legal,
        archive_nombre,
        archive_tipo
      `)
                .order('id', { ascending: false });

            if (error) {
                console.error('Supabase error (cargarDatosIniciales):', error);
                permisosGuardados = [];
                mostrarVistaActual(permisosGuardados);
                actualizarContadores();
                return;
            }

            permisosGuardados = (data || []).map(item => ({
                id: item.id,
                asigna: item.anexa ?? '',
                bloque: item.bloque ?? '',
                sucursal: item.sucursal ?? '',
                permiso: item.tipo_permiso ?? '',
                existencia: item.existencia ?? '',
                estatus: item.estatus ?? 'pendiente',
                fechaExpedicion: item.fecha_expedicion ?? null,
                fechaRenovacion: item.fecha_renovacion ?? null,
                estatusLegal: item.estatus_legal ?? '',
                permisoLegal: item.permiso_legal ?? '',
                archivoNombre: item.archive_nombre ?? null,
                archivoTipo: item.archive_tipo ?? null,
                // NO viene en la carga inicial (se trae bajo demanda)
                archivoData: null
            }));

            console.log('Total filas:', permisosGuardados.length);
            mostrarVistaActual(permisosGuardados);
            actualizarContadores();
        }

        function mostrarVistaActual(registros) {
            if (currentView === 'tabla') mostrarRegistrosEnTabla(registros);
            else mostrarKanban(registros);
        }

        // =========================
        // TABLA
        // =========================
        function mostrarRegistrosEnTabla(registros) {
            const tablaBody = document.getElementById('tablaBody');
            if (!tablaBody) return;

            tablaBody.innerHTML = '';
            document.getElementById('contadorRegistros').textContent = registros.length;

            if (registros.length === 0) {
                tablaBody.innerHTML = `
        <tr><td colspan="11" style="text-align: center; color: #aaa; padding: 2rem;">
          No hay registros. Haz clic en "Agregar" para crear uno.
        </td></tr>`;
                return;
            }

            registros.forEach((permiso, index) => {
                let estadoColor = '#aaa';
                let estadoTexto = 'PENDIENTE';

                switch (permiso.estatus) {
                    case 'vigente':
                        estadoColor = '#4caf50';
                        estadoTexto = 'VIGENTE';
                        break;
                    case 'en-tramite':
                        estadoColor = '#ff9800';
                        estadoTexto = 'EN TRÁMITE';
                        break;
                    case 'vencido':
                        estadoColor = '#f44336';
                        estadoTexto = 'VENCIDO';
                        break;
                    case 'proximo-a-vencer':
                        estadoColor = '#ff9800';
                        estadoTexto = 'PRÓXIMO A VENCER';
                        break;
                    default:
                        estadoColor = '#9c27b0';
                        estadoTexto = 'PENDIENTE';
                }

                let archivoHTML = '<span style="color: #666;">Sin archivo</span>';
                if (permiso.archivoNombre) {
                    const fileIcon = getFileIcon(permiso.archivoNombre);
                    archivoHTML = `
          <a href="#" class="document-link ver-archivo-btn" data-index="${index}">
            <i class="fas ${fileIcon}"></i> ${permiso.archivoNombre}
          </a>
        `;
                }

                let diasInfo = '';
                if (permiso.fechaRenovacion) {
                    const hoy = new Date();
                    const fechaVen = new Date(permiso.fechaRenovacion);
                    const diffTime = fechaVen - hoy;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays > 0) diasInfo = `<br><small style="color: #aaa; font-size: 0.8rem;">Vence en ${diffDays} días</small>`;
                    else if (diffDays === 0) diasInfo = `<br><small style="color: #ff9800; font-size: 0.8rem;">Vence hoy</small>`;
                    else diasInfo = `<br><small style="color: #f44336; font-size: 0.8rem;">Vencido hace ${Math.abs(diffDays)} días</small>`;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
        <td>${normalizarTxt(permiso.bloque)}</td>
        <td>${normalizarTxt(permiso.sucursal)}</td>
        <td>${normalizarTxt(permiso.permiso)}</td>
        <td>${normalizarTxt(permiso.existencia)}</td>
        <td>
          <span class="status-badge" style="
            background-color: ${estadoColor}20;
            color: ${estadoColor};
            border-color: ${estadoColor}40;
            ${permiso.estatus === 'proximo-a-vencer' ? 'font-weight: bold;' : ''}
          ">${estadoTexto}</span>
          ${diasInfo}
        </td>
        <td>${normalizarTxt(permiso.fechaExpedicion)}</td>
        <td>${normalizarTxt(permiso.fechaRenovacion)}</td>
        <td>${normalizarTxt(permiso.estatusLegal)}</td>
        <td>${normalizarTxt(permiso.permisoLegal)}</td>
        <td>${archivoHTML}</td>
        <td>
          <button class="table-action-btn editar-btn" data-index="${index}">
            <i class="fas fa-edit"></i> Editar
          </button>
          <button class="table-action-btn eliminar-btn" data-index="${index}" style="color: #ff6b6b;">
            <i class="fas fa-trash"></i> Eliminar
          </button>
        </td>
      `;
                tablaBody.appendChild(row);
            });

            document.querySelectorAll('.editar-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    abrirModal(parseInt(this.dataset.index));
                });
            });

            document.querySelectorAll('.eliminar-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    if (confirm('¿Estás seguro de eliminar este registro?')) {
                        eliminarRegistro(parseInt(this.dataset.index));
                    }
                });
            });

            document.querySelectorAll('.ver-archivo-btn').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    mostrarArchivoModal(parseInt(this.dataset.index));
                });
            });
        }

        // =========================
        // ARCHIVOS: CARGA BAJO DEMANDA
        // =========================
        async function obtenerArchivoDataPorId(id) {
            const { data, error } = await supabaseClient
                .from('datos_financieros')
                .select('archive_data, archive_tipo, archive_nombre')
                .eq('id', id)
                .single();

            if (error) throw error;
            return data;
        }

        async function asegurarArchivoCargado(index) {
            const permiso = permisosGuardados[index];
            if (!permiso) throw new Error('Registro inválido');

            if (permiso.archivoData) return permiso; // ya está

            if (!permiso.id) throw new Error('El registro no tiene ID');

            const fileRow = await obtenerArchivoDataPorId(permiso.id);
            permiso.archivoData = fileRow.archive_data || null;
            permiso.archivoTipo = fileRow.archive_tipo || permiso.archivoTipo || null;
            permiso.archivoNombre = fileRow.archive_nombre || permiso.archivoNombre || null;

            return permiso;
        }

        async function mostrarArchivoModal(index) {
            try {
                const permiso = permisosGuardados[index];
                if (!permiso?.archivoNombre) {
                    alert('No hay archivo para mostrar');
                    return;
                }

                await asegurarArchivoCargado(index);

                if (!permisosGuardados[index].archivoData) {
                    alert('No se pudo cargar el archivo');
                    return;
                }

                const p = permisosGuardados[index];
                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.style.display = 'flex';

                const fileData = `data:${p.archivoTipo};base64,${p.archivoData}`;
                let contenido = '';

                if ((p.archivoTipo || '').startsWith('image/')) {
                    contenido = `<img src="${fileData}" style="max-width: 100%; max-height: 70vh;" alt="${p.archivoNombre}">`;
                } else if (p.archivoTipo === 'application/pdf') {
                    contenido = `<iframe src="${fileData}" style="width: 100%; height: 70vh;" frameborder="0"></iframe>`;
                } else if ((p.archivoTipo || '').includes('text/')) {
                    try {
                        const textContent = atob(p.archivoData);
                        contenido = `<pre style="background: #2a2a2a; padding: 1rem; border-radius: 6px; max-height: 70vh; overflow: auto;">${textContent}</pre>`;
                    } catch {
                        contenido = '<p>No se puede previsualizar este tipo de archivo. Usa el botón de descarga.</p>';
                    }
                } else {
                    contenido = '<p>No se puede previsualizar este tipo de archivo. Usa el botón de descarga.</p>';
                }

                modal.innerHTML = `
        <div class="modal-box" style="max-width: 800px;">
          <div class="modal-header">
            <h3 style="margin: 0; font-size: 1.3rem;">
              <i class="fas ${getFileIcon(p.archivoNombre)}"></i> ${p.archivoNombre}
            </h3>
            <button class="modal-close cerrar-archivo-modal">&times;</button>
          </div>
          <div class="modal-body" style="text-align: center;">
            ${contenido}
          </div>
          <div class="modal-footer">
            <button onclick="descargarArchivoDirecto(${index})" class="btn-primary-custom">
              <i class="fas fa-download"></i> Descargar Archivo
            </button>
          </div>
        </div>
      `;

                document.body.appendChild(modal);

                modal.querySelector('.cerrar-archivo-modal').addEventListener('click', () => {
                    document.body.removeChild(modal);
                });

                modal.addEventListener('click', (e) => {
                    if (e.target === modal) document.body.removeChild(modal);
                });

            } catch (e) {
                console.error('Error mostrando archivo:', e);
                alert('Error al cargar el archivo.');
            }
        }

        async function descargarArchivoDirecto(index) {
            try {
                const permiso = permisosGuardados[index];
                if (!permiso?.archivoNombre) {
                    alert('No hay archivo para descargar');
                    return;
                }

                await asegurarArchivoCargado(index);

                const p = permisosGuardados[index];
                if (!p.archivoData) {
                    alert('No se pudo cargar el archivo');
                    return;
                }

                const fileData = `data:${p.archivoTipo};base64,${p.archivoData}`;
                const link = document.createElement('a');
                link.href = fileData;
                link.download = p.archivoNombre;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (e) {
                console.error('Error descargando:', e);
                alert('Error al descargar el archivo.');
            }
        }

        // =========================
        // MODAL AGREGAR/EDITAR
        // =========================
        function abrirModal(editarIndex = -1) {
            editingIndex = editarIndex;
            const modal = document.getElementById('modalAgregar');
            const modalTitulo = document.getElementById('modalTitulo');

            modalTitulo.textContent = editarIndex >= 0 ? 'Editar Permiso' : 'Agregar Permiso';

            cargarBloquesModal();
            cargarSucursalesModal();

            if (editarIndex >= 0 && permisosGuardados[editarIndex]) {
                const p = permisosGuardados[editarIndex];
                document.getElementById('asigna').value = p.asigna || '';
                document.getElementById('bloqueModal').value = p.bloque || '';
                setTimeout(() => { document.getElementById('sucursalModal').value = p.sucursal || ''; }, 50);
                document.getElementById('permiso').value = p.permiso || '';
                document.getElementById('existencia').value = p.existencia || '';
                document.getElementById('estatus').value = p.estatus || '';
                document.getElementById('fechaExpedicion').value = p.fechaExpedicion || '';
                document.getElementById('fechaRenovacion').value = p.fechaRenovacion || '';
                document.getElementById('estatusLegal').value = p.estatusLegal || '';
                document.getElementById('permisoDigital').value = '';

                const fileInfo = document.getElementById('fileInfo');
                if (p.archivoNombre) fileInfo.innerHTML = `<i class="fas ${getFileIcon(p.archivoNombre)}"></i> Archivo actual: ${p.archivoNombre}`;
                else fileInfo.innerHTML = '';
            } else {
                document.getElementById('asigna').value = 'Christian M';
                document.getElementById('bloqueModal').value = '';
                document.getElementById('sucursalModal').value = '';
                document.getElementById('permiso').value = 'Anuncios';
                document.getElementById('existencia').value = 'Recibo';
                document.getElementById('estatus').value = 'vigente';

                const today = new Date();
                const nextYear = new Date(today);
                nextYear.setFullYear(today.getFullYear() + 1);

                document.getElementById('fechaExpedicion').value = today.toISOString().split('T')[0];
                document.getElementById('fechaRenovacion').value = nextYear.toISOString().split('T')[0];
                document.getElementById('estatusLegal').value = '✓';
                document.getElementById('permisoDigital').value = '';
                document.getElementById('fileInfo').innerHTML = '';
            }

            modal.style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('modalAgregar').style.display = 'none';
            editingIndex = -1;
        }

        function cargarBloquesModal() {
            const select = document.getElementById('bloqueModal');
            const bloquesUnicos = [...new Set(branchData.map(b => b.block))].sort();
            select.innerHTML = '<option value="">Seleccionar bloque</option>' +
                bloquesUnicos.map(b => `<option value="${b}">Bloque ${b}</option>`).join('');
        }

        function cargarSucursalesModal() {
            const bloque = document.getElementById('bloqueModal').value;
            const select = document.getElementById('sucursalModal');
            select.innerHTML = '<option value="">Seleccionar sucursal</option>';

            let sucursales = [];
            if (bloque) {
                sucursales = branchData.filter(b => b.block === bloque)
                    .sort((a, b) => a.name.localeCompare(b.name));
            } else {
                sucursales = [...new Set(branchData.map(b => b.name))].sort();
            }

            sucursales.forEach(s => {
                const option = document.createElement('option');
                option.value = typeof s === 'object' ? s.name : s;
                option.textContent = typeof s === 'object' ? s.name : s;
                select.appendChild(option);
            });
        }

        // =========================
        // GUARDAR
        // =========================
        function calcularEstatusAlGuardar(fechaRenovacion, estatusSeleccionado) {
            if (!fechaRenovacion) return estatusSeleccionado || 'pendiente';

            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);

            const fechaVen = new Date(fechaRenovacion);
            fechaVen.setHours(0, 0, 0, 0);

            const diffDays = Math.ceil((fechaVen - hoy) / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return 'vencido';
            if (diffDays <= 7) return 'proximo-a-vencer';
            return 'vigente';
        }

        async function guardarPermiso() {
            const asigna = document.getElementById('asigna').value;
            const bloque = document.getElementById('bloqueModal').value;
            const sucursal = document.getElementById('sucursalModal').value;
            const permiso = document.getElementById('permiso').value;
            const fechaRenovacion = document.getElementById('fechaRenovacion').value;
            const estatusSeleccionado = document.getElementById('estatus').value;

            if (!asigna || !bloque || !sucursal || !permiso) {
                alert('Por favor complete Asigna, Bloque, Sucursal y Permiso');
                return;
            }

            const estatusCalculado = calcularEstatusAlGuardar(fechaRenovacion, estatusSeleccionado);

            const nuevoPermiso = {
                // IMPORTANTE: NO INVENTAR ID PARA INSERT, lo pone la BD
                id: (editingIndex >= 0 ? permisosGuardados[editingIndex].id : null),
                asigna,
                bloque,
                sucursal,
                permiso,
                existencia: document.getElementById('existencia').value,
                estatus: estatusCalculado,
                fechaExpedicion: document.getElementById('fechaExpedicion').value,
                fechaRenovacion,
                estatusLegal: document.getElementById('estatusLegal').value,
                permisoLegal: (editingIndex >= 0 ? permisosGuardados[editingIndex].permisoLegal : ''),
                archivoNombre: '',
                archivoData: '',
                archivoTipo: ''
            };

            const fileInput = document.getElementById('permisoDigital');

            if (fileInput && fileInput.files.length > 0) {
                const file = fileInput.files[0];

                // Recomendación: si suben archivos grandes, aquí es donde te puede explotar.
                // Si quieres, pongo límite de tamaño.
                const reader = new FileReader();
                reader.onload = function (e) {
                    nuevoPermiso.archivoNombre = file.name;
                    nuevoPermiso.archivoData = e.target.result.split(',')[1];
                    nuevoPermiso.archivoTipo = file.type;
                    finalizarGuardado(nuevoPermiso);
                };
                reader.readAsDataURL(file);
            } else if (editingIndex >= 0 && permisosGuardados[editingIndex].archivoNombre) {
                // Mantener archivo actual si no cargan otro
                nuevoPermiso.archivoNombre = permisosGuardados[editingIndex].archivoNombre;
                nuevoPermiso.archivoData = permisosGuardados[editingIndex].archivoData || ''; // puede estar null, se trae bajo demanda
                nuevoPermiso.archivoTipo = permisosGuardados[editingIndex].archivoTipo || '';
                finalizarGuardado(nuevoPermiso);
            } else {
                finalizarGuardado(nuevoPermiso);
            }
        }

        async function finalizarGuardado(nuevoPermiso) {
            const datosSupabase = {
                anexa: nuevoPermiso.asigna || '',
                bloque: nuevoPermiso.bloque || '',
                sucursal: nuevoPermiso.sucursal || '',
                tipo_permiso: nuevoPermiso.permiso || '',
                existencia: nuevoPermiso.existencia || '',
                estatus: nuevoPermiso.estatus || '',
                fecha_expedicion: nuevoPermiso.fechaExpedicion || null,
                fecha_renovacion: nuevoPermiso.fechaRenovacion || null,
                estatus_legal: nuevoPermiso.estatusLegal || '',
                // OJO: aquí estaba mal mapeado en tu código
                permiso_legal: nuevoPermiso.permisoLegal || '',
                archive_nombre: nuevoPermiso.archivoNombre || null,
                archive_data: (nuevoPermiso.archivoData ? nuevoPermiso.archivoData : null),
                archive_tipo: nuevoPermiso.archivoTipo || null,
                archivo_url: ''
            };

            try {
                if (editingIndex >= 0 && permisosGuardados[editingIndex]?.id) {
                    const id = permisosGuardados[editingIndex].id;
                    console.log('Actualizando ID:', id);

                    const { error } = await supabaseClient
                        .from('datos_financieros')
                        .update(datosSupabase)
                        .eq('id', id);

                    if (error) throw error;

                    // actualiza en memoria
                    permisosGuardados[editingIndex] = {
                        ...permisosGuardados[editingIndex],
                        ...nuevoPermiso,
                        id,
                        // si no trajiste archivoData (porque era bajo demanda), no lo borres
                        archivoData: (nuevoPermiso.archivoData ? nuevoPermiso.archivoData : permisosGuardados[editingIndex].archivoData)
                    };

                } else {
                    console.log('Insertando nuevo registro');

                    // Insert y traer ID sin cargar base64 de vuelta
                    const { data, error } = await supabaseClient
                        .from('datos_financieros')
                        .insert([datosSupabase])
                        .select('id')
                        .single();

                    if (error) throw error;

                    permisosGuardados.unshift({
                        ...nuevoPermiso,
                        id: data.id,
                        // no guardes base64 en memoria si no lo necesitas
                        archivoData: (nuevoPermiso.archivoData ? nuevoPermiso.archivoData : null)
                    });
                }

                cerrarModal();
                mostrarVistaActual(permisosGuardados);
                actualizarContadores();
                alert('Permiso guardado');

            } catch (error) {
                console.error('Error Supabase (guardar):', error);
                alert('Error guardando en Supabase. Revisa consola.');
            }
        }

        // =========================
        // ELIMINAR (OJO: en tu código original solo borrabas local)
        // =========================
        async function eliminarRegistro(index) {
            const permiso = permisosGuardados[index];
            if (!permiso?.id) return;

            try {
                const { error } = await supabaseClient
                    .from('datos_financieros')
                    .delete()
                    .eq('id', permiso.id);

                if (error) throw error;

                permisosGuardados.splice(index, 1);
                mostrarVistaActual(permisosGuardados);
                actualizarContadores();
                alert('Registro eliminado');

            } catch (e) {
                console.error('Error eliminando:', e);
                alert('Error eliminando en Supabase');
            }
        }

        // =========================
        // CONTADORES
        // =========================
        function actualizarContadores() {
            const vigentes = permisosGuardados.filter(p => p.estatus === 'vigente').length;
            const vencidos = permisosGuardados.filter(p => p.estatus === 'vencido').length;
            const enTramite = permisosGuardados.filter(p => p.estatus === 'en-tramite').length;
            const pendientes = permisosGuardados.filter(p => !p.estatus || p.estatus === 'pendiente').length;
            const proximos = permisosGuardados.filter(p => p.estatus === 'proximo-a-vencer').length;
            const total = permisosGuardados.length;

            document.getElementById('contadorVigentes').textContent = vigentes;
            document.getElementById('contadorVencidos').textContent = vencidos;
            document.getElementById('contadorTramite').textContent = enTramite;
            document.getElementById('contadorPendientes').textContent = pendientes;
            document.getElementById('contadorProximos').textContent = proximos;
            document.getElementById('contadorTotal').textContent = total;
        }

        // =========================
        // VISTAS: TABLA / KANBAN (tu kanban original lo dejo tal cual, solo llama mostrarArchivoModal)
        // =========================
        function mostrarKanban(registros) {
            const kanbanView = document.getElementById('kanbanView');
            if (!kanbanView) return;

            const columnas = [
                { id: 'vigente', titulo: 'VIGENTE', filtro: p => p.estatus === 'vigente' },
                { id: 'proximo-a-vencer', titulo: 'PRÓXIMO A VENCER', filtro: p => p.estatus === 'proximo-a-vencer' },
                { id: 'en-tramite', titulo: 'EN TRÁMITE', filtro: p => p.estatus === 'en-tramite' },
                { id: 'pendiente', titulo: 'PENDIENTE', filtro: p => !p.estatus || p.estatus === 'pendiente' },
                { id: 'vencido', titulo: 'VENCIDO', filtro: p => p.estatus === 'vencido' }
            ];

            kanbanView.innerHTML = '';
            columnas.forEach(columna => {
                const registrosColumna = registros.filter(columna.filtro);
                const columnaHTML = document.createElement('div');
                columnaHTML.className = 'kanban-columna';

                let contenido = `<div class="kanban-header ${columna.id}">${columna.titulo}</div><div class="kanban-tarjetas">`;

                if (registrosColumna.length === 0) {
                    contenido += `<div class="kanban-sin-actividades">Sin actividades</div>`;
                } else {
                    registrosColumna.forEach(permiso => {
                        const index = permisosGuardados.findIndex(p => p.id === permiso.id);
                        const fileIcon = permiso.archivoNombre ? getFileIcon(permiso.archivoNombre) : 'fa-file';

                        let diasTexto = '';
                        if (permiso.fechaRenovacion && columna.id === 'proximo-a-vencer') {
                            const hoy = new Date();
                            const fechaVen = new Date(permiso.fechaRenovacion);
                            const diffTime = fechaVen - hoy;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            diasTexto = `<div style="color: #ff9800; font-size: 0.8rem; margin-top: 0.3rem;">
              <i class="fas fa-clock"></i> Vence en ${diffDays} días
            </div>`;
                        }

                        contenido += `
            <div class="kanban-tarjeta ${columna.id}" data-index="${index}">
              <div class="kanban-sucursal">
                ${permiso.sucursal || 'Sin sucursal'} <i class="fas fa-chevron-right"></i>
              </div>
              <div class="kanban-info"><strong>Permiso:</strong> ${permiso.permiso || ''}</div>
              <div class="kanban-info"><strong>Bloque:</strong> ${permiso.bloque || ''}</div>
              <div class="kanban-info"><strong>Existencia:</strong> ${permiso.existencia || ''}</div>
              ${diasTexto}
              ${permiso.archivoNombre ? `
                <div class="kanban-archivo">
                  <a href="#" class="document-link ver-archivo-kanban" data-index="${index}">
                    <i class="fas ${fileIcon}"></i> Ver ${permiso.archivoNombre.split('.').pop().toUpperCase()}
                  </a>
                </div>` : ''}
            </div>
          `;
                    });
                }

                contenido += '</div>';
                columnaHTML.innerHTML = contenido;
                kanbanView.appendChild(columnaHTML);
            });

            document.querySelectorAll('.kanban-tarjeta').forEach(tarjeta => {
                tarjeta.addEventListener('click', function (e) {
                    if (!e.target.closest('.document-link')) {
                        mostrarDetalleModal(parseInt(this.dataset.index));
                    }
                });
            });

            document.querySelectorAll('.ver-archivo-kanban').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    mostrarArchivoModal(parseInt(this.dataset.index));
                });
            });
        }

        // =========================
        // DETALLE (tu lógica original funciona; aquí solo dejo lo mínimo para no romper)
        // =========================
        function getColorPorEstatus(estatus) {
            switch (estatus) {
                case 'vigente': return '#4caf50';
                case 'en-tramite': return '#ff9800';
                case 'vencido': return '#f44336';
                default: return '#9c27b0';
            }
        }

        function mostrarDetalleModal(index) {
            const permiso = permisosGuardados[index];
            if (!permiso) return;

            const modal = document.getElementById('modalDetalle');
            const titulo = document.getElementById('modalDetalleTitulo');
            const contenido = document.getElementById('detalleContenido');
            const btnEditar = document.getElementById('editarDesdeDetalle');

            titulo.textContent = `${permiso.sucursal || 'Permiso'}`;

            const colorEstatus = getColorPorEstatus(permiso.estatus);
            const fileIcon = permiso.archivoNombre ? getFileIcon(permiso.archivoNombre) : 'fa-file';

            let contenidoHTML = `
      <div style="margin-bottom: 1.5rem;">
        <div style="display: flex; align-items: center; margin-bottom: 1rem;">
          <span class="status-badge" style="
            background-color: ${colorEstatus}20; 
            color: ${colorEstatus}; 
            border-color: ${colorEstatus}40;
            font-size: 0.9rem;">
            ${permiso.estatus ? permiso.estatus.toUpperCase() : 'SIN ESTATUS'}
          </span>
          <span style="margin-left: auto; color: #aaa; font-size: 0.9rem;">
            ID: ${permiso.id}
          </span>
        </div>

        <div style="background-color: #2a2a2a; border-radius: 8px; padding: 1.5rem;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
            <div><div style="color:#aaa;font-size:.85rem;margin-bottom:.3rem;">Asigna</div><div style="color:white;font-weight:500;">${permiso.asigna || 'No asignado'}</div></div>
            <div><div style="color:#aaa;font-size:.85rem;margin-bottom:.3rem;">Permiso</div><div style="color:white;font-weight:500;">${permiso.permiso || 'Sin permiso'}</div></div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;">
            <div><div style="color:#aaa;font-size:.85rem;margin-bottom:.3rem;">Bloque</div><div style="color:white;font-weight:500;">${permiso.bloque || ''}</div></div>
            <div><div style="color:#aaa;font-size:.85rem;margin-bottom:.3rem;">Sucursal</div><div style="color:white;font-weight:500;">${permiso.sucursal || 'Sin sucursal'}</div></div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;">
            <div><div style="color:#aaa;font-size:.85rem;margin-bottom:.3rem;">Existencia</div><div style="color:white;font-weight:500;">${permiso.existencia || 'Sin información'}</div></div>
            <div><div style="color:#aaa;font-size:.85rem;margin-bottom:.3rem;">Estatus Legal</div><div style="color:white;font-weight:500;">${permiso.estatusLegal || 'Sin estatus legal'}</div></div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem;">
            <div><div style="color:#aaa;font-size:.85rem;margin-bottom:.3rem;">Fecha Expedición</div><div style="color:white;font-weight:500;">${permiso.fechaExpedicion || 'No especificada'}</div></div>
            <div><div style="color:#aaa;font-size:.85rem;margin-bottom:.3rem;">Fecha Renovación</div><div style="color:white;font-weight:500;">${permiso.fechaRenovacion || 'No especificada'}</div></div>
          </div>

          <div style="margin-top:1.5rem;padding-top:1rem;border-top:1px solid var(--color-border);">
            <div style="color:#aaa;font-size:.85rem;margin-bottom:.5rem;">Documento</div>
    `;

            if (permiso.archivoNombre) {
                contenidoHTML += `
        <div style="display:flex;align-items:center;gap:1rem;">
          <a href="#" class="document-link ver-archivo-detalle" data-index="${index}" style="flex:1;">
            <i class="fas ${fileIcon}"></i> ${permiso.archivoNombre}
          </a>
          <button class="btn-secondary-custom" style="padding:.4rem .8rem;font-size:.8rem;" onclick="descargarArchivoDirecto(${index})">
            <i class="fas fa-download"></i>
          </button>
        </div>
      `;
            } else {
                contenidoHTML += `<div style="color:#666;font-style:italic;">No hay documento adjunto</div>`;
            }

            contenidoHTML += `
          </div>
        </div>
      </div>
    `;

            contenido.innerHTML = contenidoHTML;

            btnEditar.onclick = function () {
                cerrarDetalleModal();
                setTimeout(() => abrirModal(index), 100);
            };

            modal.style.display = 'flex';

            const archivoLink = document.querySelector('.ver-archivo-detalle');
            if (archivoLink) {
                archivoLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    mostrarArchivoModal(index);
                });
            }
        }

        function cerrarDetalleModal() {
            const modal = document.getElementById('modalDetalle');
            if (modal) modal.style.display = 'none';
        }

        // =========================
        // VISTA
        // =========================
        function cambiarVista(vista) {
            currentView = vista;
            const tablaBtn = document.getElementById('btnVistaTabla');
            const kanbanBtn = document.getElementById('btnVistaKanban');
            const tablaContainer = document.getElementById('tablaContainer');
            const kanbanContainer = document.getElementById('kanbanContainer');

            if (vista === 'tabla') {
                tablaBtn.classList.add('active');
                kanbanBtn.classList.remove('active');
                tablaContainer.style.display = 'block';
                kanbanContainer.style.display = 'none';
                mostrarRegistrosEnTabla(permisosGuardados);
            } else {
                tablaBtn.classList.remove('active');
                kanbanBtn.classList.add('active');
                tablaContainer.style.display = 'none';
                kanbanContainer.style.display = 'block';
                mostrarKanban(permisosGuardados);
            }
        }

        // =========================
        // FILTROS (igual a tu lógica)
        // =========================
        function inicializarFiltros() {
            const blockFilter = document.getElementById('blockFilter');

            actualizarFiltroSucursales('all');

            blockFilter.addEventListener('change', function () {
                actualizarFiltroSucursales(this.value);
                filtrarVistaActual();
            });

            ['branchFilter', 'permisoFilter', 'estatusFilter'].forEach(id => {
                document.getElementById(id)?.addEventListener('change', filtrarVistaActual);
            });

            document.getElementById('busquedaInput')?.addEventListener('input', filtrarVistaActual);
        }

        function actualizarFiltroSucursales(blockValue) {
            const branchFilter = document.getElementById('branchFilter');
            branchFilter.innerHTML = '<option value="all">Todas las Sucursales</option>';

            let sucursales = [];
            if (blockValue === 'all') {
                sucursales = [...new Set(branchData.map(b => b.name))].sort();
            } else {
                sucursales = branchData.filter(b => b.block === blockValue)
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .map(b => b.name);
            }

            sucursales.forEach(sucursal => {
                const option = document.createElement('option');
                option.value = sucursal;
                option.textContent = sucursal;
                branchFilter.appendChild(option);
            });
        }

        function filtrarVistaActual() {
            const blockFilter = document.getElementById('blockFilter').value;
            const branchFilter = document.getElementById('branchFilter').value;
            const permisoFilter = document.getElementById('permisoFilter').value;
            const estatusFilter = document.getElementById('estatusFilter').value;
            const busqueda = (document.getElementById('busquedaInput').value || '').toLowerCase();

            let filtrados = [...permisosGuardados];

            if (blockFilter !== 'all') filtrados = filtrados.filter(p => String(p.bloque) === String(blockFilter));
            if (branchFilter !== 'all') filtrados = filtrados.filter(p => normalizarTxt(p.sucursal) === normalizarTxt(branchFilter));
            if (permisoFilter !== 'all') filtrados = filtrados.filter(p => normalizarTxt(p.permiso) === normalizarTxt(permisoFilter));
            if (estatusFilter !== 'all') filtrados = filtrados.filter(p => normalizarTxt(p.estatus) === normalizarTxt(estatusFilter));

            if (busqueda) {
                filtrados = filtrados.filter(p =>
                    (p.sucursal && p.sucursal.toLowerCase().includes(busqueda)) ||
                    (p.permiso && p.permiso.toLowerCase().includes(busqueda)) ||
                    (p.existencia && p.existencia.toLowerCase().includes(busqueda)) ||
                    (p.estatusLegal && p.estatusLegal.toLowerCase().includes(busqueda))
                );
            }

            mostrarVistaActual(filtrados);
        }

        // =========================
        // ACTUALIZACIÓN AUTOMÁTICA DE ESTATUS (tu lógica, pero sin usar actualizado_en si no existe)
        // =========================
        async function actualizarEstatusAutomaticamente() {
            const hoy = new Date();

            for (let i = 0; i < permisosGuardados.length; i++) {
                const permiso = permisosGuardados[i];
                if (!permiso.fechaRenovacion) continue;

                const fechaVen = new Date(permiso.fechaRenovacion);
                const diffTime = fechaVen - hoy;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                let nuevoEstatus = permiso.estatus;

                if (fechaVen < hoy && permiso.estatus !== 'vencido') nuevoEstatus = 'vencido';
                else if (diffDays <= 7 && diffDays > 0 && permiso.estatus !== 'proximo-a-vencer') nuevoEstatus = 'proximo-a-vencer';
                else if (permiso.estatus === 'proximo-a-vencer' && diffDays > 7) nuevoEstatus = 'vigente';

                if (nuevoEstatus !== permiso.estatus) {
                    permisosGuardados[i].estatus = nuevoEstatus;

                    try {
                        const { error } = await supabaseClient
                            .from('datos_financieros')
                            .update({ estatus: nuevoEstatus })
                            .eq('id', permiso.id);

                        if (error) console.error('Error actualizando estatus:', error);
                    } catch (e) {
                        console.error('Error actualizando estatus:', e);
                    }
                }
            }

            mostrarVistaActual(permisosGuardados);
            actualizarContadores();
        }

        // =========================
        // INICIO
        // =========================
        document.addEventListener('DOMContentLoaded', async function () {
            await cargarDatosIniciales();
            inicializarFiltros();

            setTimeout(() => { actualizarEstatusAutomaticamente(); }, 2000);
            setInterval(() => { actualizarEstatusAutomaticamente(); }, 60 * 60 * 1000);
        });

        // Eventos de vista
        document.getElementById('btnVistaTabla').addEventListener('click', () => cambiarVista('tabla'));
        document.getElementById('btnVistaKanban').addEventListener('click', () => cambiarVista('kanban'));

        // Eventos de modal principal
        document.getElementById('btnAgregar').addEventListener('click', () => abrirModal());
        document.getElementById('cancelarModal').addEventListener('click', cerrarModal);
        document.getElementById('guardarRegistro').addEventListener('click', guardarPermiso);

        document.getElementById('modalAgregar').addEventListener('click', function (e) {
            if (e.target === this) cerrarModal();
        });

        document.getElementById('bloqueModal').addEventListener('change', cargarSucursalesModal);

        document.getElementById('permisoDigital').addEventListener('change', function () {
            const fileInfo = document.getElementById('fileInfo');
            if (this.files.length > 0) {
                const file = this.files[0];
                const fileSize = (file.size / 1024).toFixed(2);
                fileInfo.innerHTML = `<i class="fas ${getFileIcon(file.name)}"></i> ${file.name} (${fileSize} KB)`;
            } else {
                fileInfo.innerHTML = '';
            }
        });

        document.getElementById('modalDetalle').addEventListener('click', function (e) {
            if (e.target === this) cerrarDetalleModal();
        });

    </script>
</body>

</html>