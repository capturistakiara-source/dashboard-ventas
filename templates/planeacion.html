<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Planeaci√≥n - La Postal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="static/css/planeacion.css">
</head>

<body>
    <!-- NAVBAR -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('home') }}">
                LA POSTAL | PLANEACI√ìN
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    Hola, <span style="color: #b71c1c; font-weight: 500;" id="nombreUsuario">{{ current_user.nombre
                        }}</span>
                </span>
                <a class="nav-link" href="{{ url_for('home') }}">Dashboard</a>
                <a class="nav-link" href="{{ url_for('perfil') }}">Perfil</a>
                <a class="nav-link" href="{{ url_for('logout') }}">Salir</a>
            </div>
        </div>
    </nav>

    <!-- ENCABEZADO CORPORATIVO -->
    <div class="corporate-header">
        <div class="container">
            <div class="header-logo">LA POSTAL</div>
            <div class="header-subtitle">Sistema de Gesti√≥n de Actividades</div>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL -->
    <div class="main-container">
        <!-- TARJETAS RESUMEN -->
        <div class="row summary-cards g-3 mt-0">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="summary-card sales" onclick="generarReporte('vigentes')" style="cursor: pointer;">
                        <div class="card-number" id="contadorVigentes">0</div>
                        <div class="card-label">VIGENTES</div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="summary-card customers" onclick="generarReporte('vencidos')" style="cursor: pointer;">
                        <div class="card-number" id="contadorVencidos">0</div>
                        <div class="card-label">VENCIDOS</div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="summary-card average" onclick="generarReporte('en-tramite')" style="cursor: pointer;">
                        <div class="card-number" id="contadorTramite">0</div>
                        <div class="card-label">EN TR√ÅMITE</div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="summary-card target" onclick="generarReporte('pendientes')" style="cursor: pointer;">
                        <div class="card-number" id="contadorPendientes">0</div>
                        <div class="card-label">PENDIENTES</div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="summary-card" style="--card-color: #9c27b0; cursor: pointer;"
                        onclick="generarReporte('proximos-a-vencer')">
                        <div class="card-number" id="contadorProximos">0</div>
                        <div class="card-label">PR√ìXIMOS A VENCER</div>
                    </div>
                </div>

                <div class="col-md-4">
                    <div class="summary-card" style="--card-color: #607d8b; cursor: pointer;"
                        onclick="generarReporte('todos')">
                        <div class="card-number" id="contadorTotal">0</div>
                        <div class="card-label">TOTAL</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTROLES DE VISTA -->
        <div class="view-controls">
            <h6 class="mb-3" style="color: #aaa;">EJEMPLO</h6>
            <div class="d-flex flex-wrap">
                <button class="view-btn active" id="btnVistaTabla">
                    <span class="kanji-header" style="font-size: 0.9rem;">Êùø</span> Tabla
                </button>
                <button class="view-btn" id="btnVistaKanban">
                    <span class="kanji-header" style="font-size: 0.7rem;">ÁúãÊùø</span> Kanban
                </button>
            </div>
        </div>

        <!-- √ÅREA DE FILTROS -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">Bloque:</label>
                    <select class="filter-select" id="blockFilter">
                        <option value="all">Todas las Sucursales</option>
                        <option value="1">Bloque 1</option>
                        <option value="2">Bloque 2</option>
                        <option value="3">Bloque 3</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Sucursales:</label>
                    <select class="filter-select" id="branchFilter">
                        <option value="all">Todas las Sucursales</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Permiso:</label>
                    <select class="filter-select" id="permisoFilter">
                        <option value="all">Todos</option>
                        <option>Anuncios</option>
                        <option>Atrapa la grasa</option>
                        <option>Basura</option>
                        <option>Bomberos</option>
                        <option>Cofepris</option>
                        <option>Dictamen de gas</option>
                        <option>Dictamen termografico</option>
                        <option>Impacto de anuencia ambiental</option>
                        <option>Linea Amarilla</option>
                        <option>Operaciones</option>
                        <option>Plano</option>
                        <option>Residuos solidos urbanos (RSU)</option>
                        <option>Uso de suelo</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Estatus:</label>
                    <select class="filter-select" id="estatusFilter">
                        <option value="all">Todos</option>
                        <option value="vigente">Vigente</option>
                        <option value="en-tramite">En tr√°mite</option>
                        <option value="vencido">Vencido</option>
                        <option value="pendiente">Pendiente</option>
                    </select>
                </div>
                <div class="search-box">
                    <label class="filter-label">B√∫squeda Avanzada</label>
                    <input type="text" class="search-input" id="busquedaInput"
                        placeholder="Buscar por producto, c√≥digo, descripci√≥n...">
                </div>
            </div>
        </div>

        <!-- SEPARADOR -->
        <div class="section-divider"></div>

        <!-- TABLA DE DATOS -->
        <div class="data-table-container" id="tablaContainer">
            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th style="width: 5%;">BLOQUE</th>
                            <th style="width: 20%;">SUCURSAL</th>
                            <th style="width: 10%;">PERMISO</th>
                            <th style="width: 10%;">EXISTENCIA</th>
                            <th style="width: 10%;">ESTATUS</th>
                            <th style="width: 10%;">FECHA EXPEDICION</th>
                            <th style="width: 10%;">FECHA RENOVACION</th>
                            <th style="width: 10%;">ESTATUS LEGAL</th>
                            <th style="width: 10%;">PERMISO LEGAL</th>
                            <th style="width: 15%;">PERMISO DIGITAL</th>
                            <th style="width: 15%;">ACCIONES</th>
                        </tr>
                    </thead>
                    <tbody id="tablaBody"></tbody>
                </table>
            </div>

            <!-- PIE DE TABLA -->
            <div style="padding: 1rem 1.5rem; background-color: #1a1a1a; border-top: 1px solid var(--color-border);">
                <div class="d-flex justify-content-between align-items-center">
                    <div style="color: #aaa; font-size: 0.9rem;">
                        Mostrando <span id="contadorRegistros">0</span> registros
                    </div>
                    <div>
                        <button id="btnAgregar" class="btn-secondary-custom">
                            <i class="fas fa-plus me-1"></i> Agregar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CONTENEDOR KANBAN -->
        <div id="kanbanContainer" class="data-table-container" style="display: none;">
            <div id="kanbanView" class="kanban-view"></div>
        </div>

        <!-- MODAL VER DETALLES -->
        <div id="modalDetalle" class="modal-overlay">
            <div class="modal-box" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 id="modalDetalleTitulo" style="margin: 0; font-size: 1.3rem;">Detalles del Permiso</h3>
                </div>
                <div class="modal-body">
                    <div id="detalleContenido"></div>
                </div>
                <div class="modal-footer">
                    <button id="editarDesdeDetalle" class="btn-primary-custom" style="margin-right: 0.5rem;">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                </div>
            </div>
        </div>

        <!-- MODAL AGREGAR REGISTRO -->
        <div id="modalAgregar" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-header">
                    <h3 id="modalTitulo" style="margin: 0; font-size: 1.3rem;">Agregar Permiso</h3>
                </div>
                <div class="modal-body">
                    <div class="form-grid">
                        <div>
                            <label>Asigna</label>
                            <select id="asigna">
                                <option value="">Seleccionar</option>
                                <option>Christian M</option>
                                <option>Antonio S</option>
                                <option>Omar R</option>
                            </select>
                        </div>
                        <div>
                            <label>Bloque</label>
                            <select id="bloqueModal"></select>
                        </div>
                        <div>
                            <label>Sucursal</label>
                            <select id="sucursalModal"></select>
                        </div>
                        <div>
                            <label>Permiso</label>
                            <select id="permiso">
                                <option>Anuncios</option>
                                <option>Atrapa la grasa</option>
                                <option>Basura</option>
                                <option>Bomberos</option>
                                <option>Cofepris</option>
                                <option>Dictamen de gas</option>
                                <option>Dictamen termografico</option>
                                <option>Impacto de anuencia ambiental</option>
                                <option>Linea Amarilla</option>
                                <option>Operaciones</option>
                                <option>Plano</option>
                                <option>Residuos solidos urbanos (RSU)</option>
                                <option>Uso de suelo</option>
                            </select>
                        </div>
                        <div>
                            <label>Existencia</label>
                            <select id="existencia">
                                <option>Recibo</option>
                                <option>Recibo N/T</option>
                                <option>Licencia</option>
                                <option>Licencia N/T</option>
                            </select>
                        </div>
                        <div>
                            <label>Estatus</label>
                            <select id="estatus">
                                <option value="vigente">Vigente</option>
                                <option value="en-tramite">En tr√°mite</option>
                                <option value="vencido">Vencido</option>
                                <option value="pendiente">Pendiente</option>
                            </select>
                        </div>
                        <div>
                            <label>Fecha Expedici√≥n</label>
                            <input type="date" id="fechaExpedicion">
                        </div>
                        <div>
                            <label>Fecha Renovaci√≥n</label>
                            <input type="date" id="fechaRenovacion">
                        </div>
                        <div>
                            <label>Estatus Legal</label>
                            <select id="estatusLegal">
                                <option>‚úì</option>
                                <option>Dependencia a otro permiso</option>
                                <option>En espera de legal</option>
                                <option>En espero de permiso</option>
                                <option>Falta pago</option>
                                <option>Faltan Modificaciones</option>
                                <option>Modificaciones</option>
                                <option>Primer pago</option>
                                <option>Segundo Pago</option>
                            </select>
                        </div>
                        <div>
                            <label>Documento Digital</label>
                            <input type="file" id="permisoDigital" accept="*/*">
                            <div class="file-info" id="fileInfo"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="cancelarModal" class="btn-secondary-custom">Cancelar</button>
                    <button id="guardarRegistro" class="btn-primary-custom">Guardar</button>
                </div>
            </div>
        </div>

        <!-- MODAL REPORTES -->
        <div class="modal fade" id="reporteModal" tabindex="-1" aria-labelledby="reporteModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="text-center py-5" id="modalLoading">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-3">Generando reporte...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // CONFIGURACI√ìN SUPABASE
        const SUPABASE_URL = 'https://uooffrtjajluvhcauctk.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_ib_7iPl1ccS0PGo3yKzggQ_nWMi9CU8';
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DATOS Y VARIABLES GLOBALES
        const branchData = [
            { name: "5 Y 10", block: "3" }, { name: "ALEM√ÅN", block: "3" },
            { name: "BRISAS", block: "1" }, { name: "CACHO", block: "1" },
            { name: "CALIFORNIAS", block: "3" }, { name: "CAMPESTRE MURUA", block: "3" },
            { name: "CAMPI√ëA", block: "3" }, { name: "CAPISTRANO", block: "3" },
            { name: "COLINA AZUL", block: "3" }, { name: "DARUMMITA LIBERTAD", block: "3" },
            { name: "DARUMMITA PLAYAS", block: "2" }, { name: "ENSENADA", block: "1" },
            { name: "FLORIDO", block: "3" }, { name: "INDEPENDENCIA", block: "3" },
            { name: "LAGO", block: "3" }, { name: "LIBERTAD", block: "3" },
            { name: "MALEC√ìN", block: "3" }, { name: "MALEC√ìN 2", block: "3" },
            { name: "MARIANO MATAMOROS", block: "3" }, { name: "MATRIZ", block: "1" },
            { name: "MURUA", block: "3" }, { name: "PANAMERICANO", block: "3" },
            { name: "PLAYAS 1", block: "1" }, { name: "ROSARITO 3", block: "2" },
            { name: "SOLER", block: "3" }, { name: "TORRES", block: "1" },
            { name: "VENECIA", block: "3" }, { name: "ZONA NORTE", block: "3" },
            { name: "ZONA R√çO", block: "3" }
        ];

        // Iconos para archivos
        const fileIcons = {
            'pdf': 'fa-file-pdf',
            'doc': 'fa-file-word',
            'docx': 'fa-file-word',
            'xls': 'fa-file-excel',
            'xlsx': 'fa-file-excel',
            'jpg': 'fa-file-image',
            'jpeg': 'fa-file-image',
            'png': 'fa-file-image',
            'txt': 'fa-file-alt',
            'zip': 'fa-file-archive',
            'rar': 'fa-file-archive',
            'default': 'fa-file'
        };

        let permisosGuardados = [];
        let editingIndex = -1;
        let currentView = 'tabla';
        let reporteActual = '';

        // FUNCIONES PRINCIPALES
        async function cargarDatosIniciales() {
            try {
                console.log('üîÑ Cargando datos desde Supabase...');
                const { data, error } = await supabaseClient
                    .from('datos_financieros')
                    .select('*')
                    .order('creado_en', { ascending: false });

                if (error) throw error;

                if (data && data.length > 0) {
                    permisosGuardados = data.map(item => ({
                        id: item.id,
                        asigna: item.anexa,
                        bloque: item.bloque,
                        sucursal: item.sucursal,
                        permiso: item.tipo_permiso,
                        existencia: item.existencia,
                        estatus: item.estatus,
                        fechaExpedicion: item.fecha_expedicion,
                        fechaRenovacion: item.fecha_renovacion,
                        estatusLegal: item.estatus_legal,
                        permisoLegal: item.permiso_legal,
                        archivoNombre: item.archive_nombre,
                        archivoData: item.archive_data,
                        archivoTipo: item.archive_tipo,
                        fechaCreacion: item.creado_en
                    }));
                    console.log(`‚úÖ Cargados ${permisosGuardados.length} registros`);
                } else {
                    console.log('‚ÑπÔ∏è No hay datos en Supabase');
                    permisosGuardados = JSON.parse(localStorage.getItem('permisos')) || [];
                }
                localStorage.setItem('permisos', JSON.stringify(permisosGuardados));
            } catch (error) {
                console.error('‚ùå Error:', error);
                permisosGuardados = JSON.parse(localStorage.getItem('permisos')) || [];
            }
            mostrarRegistrosEnTabla(permisosGuardados);
            actualizarContadores();
        }

        function mostrarRegistrosEnTabla(registros) {
            const tablaBody = document.getElementById('tablaBody');
            if (!tablaBody) return;

            tablaBody.innerHTML = '';
            document.getElementById('contadorRegistros').textContent = registros.length;

            if (registros.length === 0) {
                tablaBody.innerHTML = `
            <tr><td colspan="11" style="text-align: center; color: #aaa; padding: 2rem;">
                No hay registros. Haz clic en "Agregar" para crear uno.
            </td></tr>`;
                return;
            }

            registros.forEach((permiso, index) => {
                let estadoColor = '#aaa';
                let estadoTexto = 'PENDIENTE';

                // Asignar colores seg√∫n estatus
                switch (permiso.estatus) {
                    case 'vigente':
                        estadoColor = '#4caf50';
                        estadoTexto = 'VIGENTE';
                        break;
                    case 'en-tramite':
                        estadoColor = '#ff9800';
                        estadoTexto = 'EN TR√ÅMITE';
                        break;
                    case 'vencido':
                        estadoColor = '#f44336';
                        estadoTexto = 'VENCIDO';
                        break;
                    case 'proximo-a-vencer':
                        estadoColor = '#ff9800';
                        estadoTexto = 'PR√ìXIMO A VENCER';
                        break;
                    default:
                        estadoColor = '#9c27b0';
                        estadoTexto = 'PENDIENTE';
                }

                // Archivo con icono
                let archivoHTML = '<span style="color: #666;">Sin archivo</span>';
                if (permiso.archivoNombre) {
                    const fileIcon = getFileIcon(permiso.archivoNombre);
                    archivoHTML = `
                <a href="#" class="document-link ver-archivo-btn" data-index="${index}">
                    <i class="fas ${fileIcon}"></i> ${permiso.archivoNombre}
                </a>
            `;
                }

                // Calcular d√≠as restantes si tiene fecha de renovaci√≥n
                let diasInfo = '';
                if (permiso.fechaRenovacion) {
                    const hoy = new Date();
                    const fechaVen = new Date(permiso.fechaRenovacion);
                    const diffTime = fechaVen - hoy;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays > 0) {
                        diasInfo = `<br><small style="color: #aaa; font-size: 0.8rem;">Vence en ${diffDays} d√≠as</small>`;
                    } else if (diffDays === 0) {
                        diasInfo = `<br><small style="color: #ff9800; font-size: 0.8rem;">¬°Vence hoy!</small>`;
                    } else {
                        diasInfo = `<br><small style="color: #f44336; font-size: 0.8rem;">Vencido hace ${Math.abs(diffDays)} d√≠as</small>`;
                    }
                }

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${permiso.bloque || ''}</td>
            <td>${permiso.sucursal || ''}</td>
            <td>${permiso.permiso || ''}</td>
            <td>${permiso.existencia || ''}</td>
            <td>
                <span class="status-badge" style="
                    background-color: ${estadoColor}20; 
                    color: ${estadoColor}; 
                    border-color: ${estadoColor}40;
                    ${permiso.estatus === 'proximo-a-vencer' ? 'font-weight: bold;' : ''}
                ">
                    ${estadoTexto}
                </span>
                ${diasInfo}
            </td>
            <td>${permiso.fechaExpedicion || ''}</td>
            <td>${permiso.fechaRenovacion || ''}</td>
            <td>${permiso.estatusLegal || ''}</td>
            <td>${permiso.permisoLegal || ''}</td>
            <td>${archivoHTML}</td>
            <td>
                <button class="table-action-btn editar-btn" data-index="${index}">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button class="table-action-btn eliminar-btn" data-index="${index}" style="color: #ff6b6b;">
                    <i class="fas fa-trash"></i> Eliminar
                </button>
            </td>
        `;
                tablaBody.appendChild(row);
            });

            // Eventos
            document.querySelectorAll('.editar-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    abrirModal(parseInt(this.dataset.index));
                });
            });

            document.querySelectorAll('.eliminar-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    if (confirm('¬øEst√°s seguro de eliminar este registro?')) {
                        eliminarRegistro(parseInt(this.dataset.index));
                    }
                });
            });

            document.querySelectorAll('.ver-archivo-btn').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    mostrarArchivoModal(parseInt(this.dataset.index));
                });
            });
        }

        // FUNCI√ìN PARA OBTENER ICONO DE ARCHIVO
        function getFileIcon(filename) {
            if (!filename) return fileIcons.default;
            const extension = filename.split('.').pop().toLowerCase();
            return fileIcons[extension] || fileIcons.default;
        }

        // MODAL DE ARCHIVOS
        function mostrarArchivoModal(index) {
            const permiso = permisosGuardados[index];
            if (!permiso.archivoData) {
                alert('No hay archivo para mostrar');
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.style.display = 'flex';

            const fileData = `data:${permiso.archivoTipo};base64,${permiso.archivoData}`;
            let contenido = '';

            if (permiso.archivoTipo.startsWith('image/')) {
                contenido = `<img src="${fileData}" style="max-width: 100%; max-height: 70vh;" alt="${permiso.archivoNombre}">`;
            } else if (permiso.archivoTipo === 'application/pdf') {
                contenido = `<iframe src="${fileData}" style="width: 100%; height: 70vh;" frameborder="0"></iframe>`;
            } else if (permiso.archivoTipo.includes('text/')) {
                try {
                    const textContent = atob(permiso.archivoData);
                    contenido = `<pre style="background: #2a2a2a; padding: 1rem; border-radius: 6px; max-height: 70vh; overflow: auto;">${textContent}</pre>`;
                } catch (e) {
                    contenido = '<p>No se puede previsualizar este tipo de archivo. Usa el bot√≥n de descarga.</p>';
                }
            } else {
                contenido = '<p>No se puede previsualizar este tipo de archivo. Usa el bot√≥n de descarga.</p>';
            }

            modal.innerHTML = `
                <div class="modal-box" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3 style="margin: 0; font-size: 1.3rem;">
                            <i class="fas ${getFileIcon(permiso.archivoNombre)}"></i> ${permiso.archivoNombre}
                        </h3>
                        <button class="modal-close cerrar-archivo-modal">&times;</button>
                    </div>
                    <div class="modal-body" style="text-align: center;">
                        ${contenido}
                    </div>
                    <div class="modal-footer">
                        <button onclick="descargarArchivoDirecto(${index})" class="btn-primary-custom">
                            <i class="fas fa-download"></i> Descargar Archivo
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            modal.querySelector('.cerrar-archivo-modal').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // FUNCI√ìN PARA DESCARGAR ARCHIVO
        function descargarArchivoDirecto(index) {
            const permiso = permisosGuardados[index];
            if (!permiso.archivoData) {
                alert('No hay archivo para descargar');
                return;
            }

            const fileData = `data:${permiso.archivoTipo};base64,${permiso.archivoData}`;
            const link = document.createElement('a');
            link.href = fileData;
            link.download = permiso.archivoNombre;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // MODAL AGREGAR/EDITAR
        function abrirModal(editarIndex = -1) {
            editingIndex = editarIndex;
            const modal = document.getElementById('modalAgregar');
            const modalTitulo = document.getElementById('modalTitulo');

            modalTitulo.textContent = editarIndex >= 0 ? 'Editar Permiso' : 'Agregar Permiso';

            cargarBloquesModal();
            cargarSucursalesModal();

            if (editarIndex >= 0 && permisosGuardados[editarIndex]) {
                const p = permisosGuardados[editarIndex];
                document.getElementById('asigna').value = p.asigna || '';
                document.getElementById('bloqueModal').value = p.bloque || '';
                setTimeout(() => {
                    document.getElementById('sucursalModal').value = p.sucursal || '';
                }, 50);
                document.getElementById('permiso').value = p.permiso || '';
                document.getElementById('existencia').value = p.existencia || '';
                document.getElementById('estatus').value = p.estatus || '';
                document.getElementById('fechaExpedicion').value = p.fechaExpedicion || '';
                document.getElementById('fechaRenovacion').value = p.fechaRenovacion || '';
                document.getElementById('estatusLegal').value = p.estatusLegal || '';
                document.getElementById('permisoDigital').value = '';

                const fileInfo = document.getElementById('fileInfo');
                if (p.archivoNombre) {
                    fileInfo.innerHTML = `<i class="fas ${getFileIcon(p.archivoNombre)}"></i> Archivo actual: ${p.archivoNombre}`;
                } else {
                    fileInfo.innerHTML = '';
                }
            } else {
                document.getElementById('asigna').value = 'Christian M';
                document.getElementById('bloqueModal').value = '';
                document.getElementById('sucursalModal').value = '';
                document.getElementById('permiso').value = 'Anuncios';
                document.getElementById('existencia').value = 'Recibo';
                document.getElementById('estatus').value = 'vigente';

                const today = new Date();
                const nextYear = new Date(today);
                nextYear.setFullYear(today.getFullYear() + 1);

                document.getElementById('fechaExpedicion').value = today.toISOString().split('T')[0];
                document.getElementById('fechaRenovacion').value = nextYear.toISOString().split('T')[0];
                document.getElementById('estatusLegal').value = '‚úì';
                document.getElementById('permisoDigital').value = '';
                document.getElementById('fileInfo').innerHTML = '';
            }

            modal.style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('modalAgregar').style.display = 'none';
            editingIndex = -1;
        }

        function cargarBloquesModal() {
            const select = document.getElementById('bloqueModal');
            const bloquesUnicos = [...new Set(branchData.map(b => b.block))].sort();
            select.innerHTML = '<option value="">Seleccionar bloque</option>' +
                bloquesUnicos.map(b => `<option value="${b}">Bloque ${b}</option>`).join('');
        }

        function cargarSucursalesModal() {
            const bloque = document.getElementById('bloqueModal').value;
            const select = document.getElementById('sucursalModal');
            select.innerHTML = '<option value="">Seleccionar sucursal</option>';

            let sucursales = [];
            if (bloque) {
                sucursales = branchData.filter(b => b.block === bloque)
                    .sort((a, b) => a.name.localeCompare(b.name));
            } else {
                sucursales = [...new Set(branchData.map(b => b.name))].sort();
            }

            sucursales.forEach(s => {
                const option = document.createElement('option');
                option.value = typeof s === 'object' ? s.name : s;
                option.textContent = typeof s === 'object' ? s.name : s;
                select.appendChild(option);
            });
        }

        async function guardarPermiso() {
            const asigna = document.getElementById('asigna').value;
            const bloque = document.getElementById('bloqueModal').value;
            const sucursal = document.getElementById('sucursalModal').value;
            const permiso = document.getElementById('permiso').value;
            const fechaRenovacion = document.getElementById('fechaRenovacion').value;
            const estatusSeleccionado = document.getElementById('estatus').value;


            if (!asigna || !bloque || !sucursal || !permiso) {
                alert('Por favor complete todos los campos obligatorios: Asigna, Bloque, Sucursal y Permiso');
                return;
            }


            // CALCULAR ESTATUS (solo si hay fecha), si no hay fecha respeta el modal
            const estatusCalculado = calcularEstatusAlGuardar(fechaRenovacion, estatusSeleccionado);

            const nuevoPermiso = {
                id: editingIndex >= 0 ? permisosGuardados[editingIndex].id : Date.now(),
                asigna: asigna,
                bloque: bloque,
                sucursal: sucursal,
                permiso: permiso,
                existencia: document.getElementById('existencia').value,
                estatus: estatusCalculado,
                fechaExpedicion: document.getElementById('fechaExpedicion').value,
                fechaRenovacion: fechaRenovacion,
                estatusLegal: document.getElementById('estatusLegal').value,
                fechaCreacion: editingIndex >= 0 ? permisosGuardados[editingIndex].fechaCreacion : new Date().toISOString().split('T')[0],
                archivoNombre: '',
                archivoData: '',
                archivoTipo: ''
            };

            console.log(`üìù Estatus calculado autom√°ticamente: ${estatusCalculado}`);

            const fileInput = document.getElementById('permisoDigital');
            if (fileInput && fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                reader.onload = function (e) {
                    nuevoPermiso.archivoNombre = file.name;
                    nuevoPermiso.archivoData = e.target.result.split(',')[1];
                    nuevoPermiso.archivoTipo = file.type;
                    finalizarGuardado(nuevoPermiso);
                };
                reader.readAsDataURL(file);
            } else if (editingIndex >= 0 && permisosGuardados[editingIndex].archivoNombre) {
                nuevoPermiso.archivoNombre = permisosGuardados[editingIndex].archivoNombre;
                nuevoPermiso.archivoData = permisosGuardados[editingIndex].archivoData;
                nuevoPermiso.archivoTipo = permisosGuardados[editingIndex].archivoTipo;
                finalizarGuardado(nuevoPermiso);
            } else {
                finalizarGuardado(nuevoPermiso);
            }
        }

        async function finalizarGuardado(nuevoPermiso) {
            const datosSupabase = {
                anexa: nuevoPermiso.asigna || '',
                bloque: nuevoPermiso.bloque || '',
                sucursal: nuevoPermiso.sucursal || '',
                tipo_permiso: nuevoPermiso.permiso || '',
                existencia: nuevoPermiso.existencia || '',
                estatus: nuevoPermiso.estatus || '',
                fecha_expedicion: nuevoPermiso.fechaExpedicion || null,
                fecha_renovacion: nuevoPermiso.fechaRenovacion || null,
                estatus_legal: nuevoPermiso.estatusLegal || '',
                permiso_legal: nuevoPermiso.estatusLegal || '',
                archive_nombre: nuevoPermiso.archivoNombre || null,
                archive_data: nuevoPermiso.archivoData || null,
                archive_tipo: nuevoPermiso.archivoTipo || null,
                archivo_url: ''
            };

            try {
                let resultadoSupabase;
                if (editingIndex >= 0 && permisosGuardados[editingIndex].id) {
                    console.log(`üìù Actualizando registro ID: ${permisosGuardados[editingIndex].id}`);
                    const { data, error } = await supabaseClient
                        .from('datos_financieros')
                        .update(datosSupabase)
                        .eq('id', permisosGuardados[editingIndex].id)
                        .select();
                    if (error) throw error;
                    resultadoSupabase = data[0];
                } else {
                    console.log('‚ûï Insertando nuevo registro');
                    const { data, error } = await supabaseClient
                        .from('datos_financieros')
                        .insert([datosSupabase])
                        .select();
                    if (error) throw error;
                    resultadoSupabase = data[0];
                }

                const permisoActualizado = {
                    ...nuevoPermiso,
                    id: resultadoSupabase.id,
                    fechaCreacion: resultadoSupabase.creado_en
                };

                if (editingIndex >= 0) {
                    permisosGuardados[editingIndex] = permisoActualizado;
                } else {
                    permisosGuardados.push(permisoActualizado);
                }

                localStorage.setItem('permisos', JSON.stringify(permisosGuardados));
                cerrarModal();
                mostrarRegistrosEnTabla(permisosGuardados);
                actualizarContadores();
                alert('‚úÖ Permiso guardado exitosamente');

            } catch (error) {
                console.error('‚ùå Error Supabase:', error);
                if (editingIndex >= 0) {
                    permisosGuardados[editingIndex] = nuevoPermiso;
                } else {
                    permisosGuardados.push(nuevoPermiso);
                }
                localStorage.setItem('permisos', JSON.stringify(permisosGuardados));
                cerrarModal();
                mostrarRegistrosEnTabla(permisosGuardados);
                actualizarContadores();
                alert('‚ö†Ô∏è Se guard√≥ localmente debido a error en Supabase');
            }
        }

        function eliminarRegistro(index) {
            permisosGuardados.splice(index, 1);
            localStorage.setItem('permisos', JSON.stringify(permisosGuardados));
            mostrarRegistrosEnTabla(permisosGuardados);
            actualizarContadores();
        }

        function actualizarContadores() {
            const vigentes = permisosGuardados.filter(p => p.estatus === 'vigente').length;
            const vencidos = permisosGuardados.filter(p => p.estatus === 'vencido').length;
            const enTramite = permisosGuardados.filter(p => p.estatus === 'en-tramite').length;
            const pendientes = permisosGuardados.filter(p => !p.estatus || p.estatus === 'pendiente').length;
            const proximos = permisosGuardados.filter(p => p.estatus === 'proximo-a-vencer').length;
            const total = permisosGuardados.length;

            document.getElementById('contadorVigentes').textContent = vigentes;
            document.getElementById('contadorVencidos').textContent = vencidos;
            document.getElementById('contadorTramite').textContent = enTramite;
            document.getElementById('contadorPendientes').textContent = pendientes;
            document.getElementById('contadorProximos').textContent = proximos;
            document.getElementById('contadorTotal').textContent = total;
        }

        // VISTAS KANBAN
        function mostrarKanban(registros) {
            const kanbanView = document.getElementById('kanbanView');
            if (!kanbanView) return;

            const columnas = [
                { id: 'vigente', titulo: 'VIGENTE', filtro: p => p.estatus === 'vigente' },
                { id: 'proximo-a-vencer', titulo: 'PR√ìXIMO A VENCER', filtro: p => p.estatus === 'proximo-a-vencer' },
                { id: 'en-tramite', titulo: 'EN TR√ÅMITE', filtro: p => p.estatus === 'en-tramite' },
                { id: 'pendiente', titulo: 'PENDIENTE', filtro: p => !p.estatus || p.estatus === 'pendiente' },
                { id: 'vencido', titulo: 'VENCIDO', filtro: p => p.estatus === 'vencido' }
            ];

            kanbanView.innerHTML = '';
            columnas.forEach(columna => {
                const registrosColumna = registros.filter(columna.filtro);
                const columnaHTML = document.createElement('div');
                columnaHTML.className = 'kanban-columna';

                let contenido = `<div class="kanban-header ${columna.id}">${columna.titulo}</div><div class="kanban-tarjetas">`;

                if (registrosColumna.length === 0) {
                    contenido += `<div class="kanban-sin-actividades">Sin actividades</div>`;
                } else {
                    registrosColumna.forEach(permiso => {
                        const index = permisosGuardados.findIndex(p => p.id === permiso.id);
                        const fileIcon = permiso.archivoNombre ? getFileIcon(permiso.archivoNombre) : 'fa-file';

                        // Calcular d√≠as restantes
                        let diasTexto = '';
                        if (permiso.fechaRenovacion && columna.id === 'proximo-a-vencer') {
                            const hoy = new Date();
                            const fechaVen = new Date(permiso.fechaRenovacion);
                            const diffTime = fechaVen - hoy;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            diasTexto = `<div style="color: #ff9800; font-size: 0.8rem; margin-top: 0.3rem;">
                        <i class="fas fa-clock"></i> Vence en ${diffDays} d√≠as
                    </div>`;
                        }

                        contenido += `
                    <div class="kanban-tarjeta ${columna.id}" data-index="${index}">
                        <div class="kanban-sucursal">
                            ${permiso.sucursal || 'Sin sucursal'}
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        <div class="kanban-info">
                            <strong>Permiso:</strong> ${permiso.permiso || ''}
                        </div>
                        <div class="kanban-info">
                            <strong>Bloque:</strong> ${permiso.bloque || ''}
                        </div>
                        <div class="kanban-info">
                            <strong>Existencia:</strong> ${permiso.existencia || ''}
                        </div>
                        ${diasTexto}
                        ${permiso.archivoNombre ? `
                        <div class="kanban-archivo">
                            <a href="#" class="document-link ver-archivo-kanban" data-index="${index}">
                                <i class="fas ${fileIcon}"></i> Ver ${permiso.archivoNombre.split('.').pop().toUpperCase()}
                            </a>
                        </div>
                        ` : ''}
                    </div>
                `;
                    });
                }
                contenido += '</div>';
                columnaHTML.innerHTML = contenido;
                kanbanView.appendChild(columnaHTML);
            });

            // Eventos para Kanban
            document.querySelectorAll('.kanban-tarjeta').forEach(tarjeta => {
                tarjeta.addEventListener('click', function (e) {
                    if (!e.target.closest('.document-link')) {
                        mostrarDetalleModal(parseInt(this.dataset.index));
                    }
                });
            });

            document.querySelectorAll('.ver-archivo-kanban').forEach(link => {
                link.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    mostrarArchivoModal(parseInt(this.dataset.index));
                });
            });
        }

        // MODAL DE DETALLES
        function mostrarDetalleModal(index) {
            const permiso = permisosGuardados[index];
            if (!permiso) return;

            const modal = document.getElementById('modalDetalle');
            const titulo = document.getElementById('modalDetalleTitulo');
            const contenido = document.getElementById('detalleContenido');
            const btnEditar = document.getElementById('editarDesdeDetalle');

            titulo.textContent = `${permiso.sucursal || 'Permiso'}`;

            const colorEstatus = getColorPorEstatus(permiso.estatus);
            const fileIcon = permiso.archivoNombre ? getFileIcon(permiso.archivoNombre) : 'fa-file';

            let contenidoHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                        <span class="status-badge" style="
                            background-color: ${colorEstatus}20; 
                            color: ${colorEstatus}; 
                            border-color: ${colorEstatus}40;
                            font-size: 0.9rem;
                        ">
                            ${permiso.estatus ? permiso.estatus.toUpperCase() : 'SIN ESTATUS'}
                        </span>
                        <span style="margin-left: auto; color: #aaa; font-size: 0.9rem;">
                            ID: ${permiso.id}
                        </span>
                    </div>
                    
                    <div style="background-color: #2a2a2a; border-radius: 8px; padding: 1.5rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <div style="color: #aaa; font-size: 0.85rem; margin-bottom: 0.3rem;">Asigna</div>
                                <div style="color: white; font-weight: 500;">${permiso.asigna || 'No asignado'}</div>
                            </div>
                            <div>
                                <div style="color: #aaa; font-size: 0.85rem; margin-bottom: 0.3rem;">Permiso</div>
                                <div style="color: white; font-weight: 500;">${permiso.permiso || 'Sin permiso'}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <div style="color: #aaa; font-size: 0.85rem; margin-bottom: 0.3rem;">Bloque</div>
                                <div style="color: white; font-weight: 500;">${permiso.bloque || ''}</div>
                            </div>
                            <div>
                                <div style="color: #aaa; font-size: 0.85rem; margin-bottom: 0.3rem;">Sucursal</div>
                                <div style="color: white; font-weight: 500;">${permiso.sucursal || 'Sin sucursal'}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <div style="color: #aaa; font-size: 0.85rem; margin-bottom: 0.3rem;">Existencia</div>
                                <div style="color: white; font-weight: 500;">${permiso.existencia || 'Sin informaci√≥n'}</div>
                            </div>
                            <div>
                                <div style="color: #aaa; font-size: 0.85rem; margin-bottom: 0.3rem;">Estatus Legal</div>
                                <div style="color: white; font-weight: 500;">${permiso.estatusLegal || 'Sin estatus legal'}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <div style="color: #aaa; font-size: 0.85rem; margin-bottom: 0.3rem;">Fecha Expedici√≥n</div>
                                <div style="color: white; font-weight: 500;">${permiso.fechaExpedicion || 'No especificada'}</div>
                            </div>
                            <div>
                                <div style="color: #aaa; font-size: 0.85rem; margin-bottom: 0.3rem;">Fecha Renovaci√≥n</div>
                                <div style="color: white; font-weight: 500;">${permiso.fechaRenovacion || 'No especificada'}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--color-border);">
                            <div style="color: #aaa; font-size: 0.85rem; margin-bottom: 0.5rem;">Documento</div>
            `;

            if (permiso.archivoNombre) {
                contenidoHTML += `
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <a href="#" class="document-link ver-archivo-detalle" data-index="${index}" style="flex: 1;">
                            <i class="fas ${fileIcon}"></i> ${permiso.archivoNombre}
                        </a>
                        <button class="btn-secondary-custom" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;" onclick="descargarArchivoDirecto(${index})">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                `;
            } else {
                contenidoHTML += `
                    <div style="color: #666; font-style: italic;">
                        No hay documento adjunto
                    </div>
                `;
            }

            contenidoHTML += `
                        </div>
                    </div>
                </div>
            `;

            contenido.innerHTML = contenidoHTML;

            btnEditar.onclick = function () {
                cerrarDetalleModal();
                setTimeout(() => {
                    abrirModal(index);
                }, 100);
            };

            modal.style.display = 'flex';

            // Evento para el enlace de archivo en el detalle
            const archivoLink = document.querySelector('.ver-archivo-detalle');
            if (archivoLink) {
                archivoLink.addEventListener('click', function (e) {
                    e.preventDefault();
                    mostrarArchivoModal(index);
                });
            }
        }

        function cerrarDetalleModal() {
            const modal = document.getElementById('modalDetalle');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        function getColorPorEstatus(estatus) {
            switch (estatus) {
                case 'vigente': return '#4caf50';
                case 'en-tramite': return '#ff9800';
                case 'vencido': return '#f44336';
                default: return '#9c27b0';
            }
        }

        function cambiarVista(vista) {
            currentView = vista;
            const tablaBtn = document.getElementById('btnVistaTabla');
            const kanbanBtn = document.getElementById('btnVistaKanban');
            const tablaContainer = document.getElementById('tablaContainer');
            const kanbanContainer = document.getElementById('kanbanContainer');

            if (vista === 'tabla') {
                tablaBtn.classList.add('active');
                kanbanBtn.classList.remove('active');
                tablaContainer.style.display = 'block';
                kanbanContainer.style.display = 'none';
                mostrarRegistrosEnTabla(permisosGuardados);
            } else {
                tablaBtn.classList.remove('active');
                kanbanBtn.classList.add('active');
                tablaContainer.style.display = 'none';
                kanbanContainer.style.display = 'block';
                mostrarKanban(permisosGuardados);
            }
        }

        // FILTROS
        function inicializarFiltros() {
            const blockFilter = document.getElementById('blockFilter');
            const branchFilter = document.getElementById('branchFilter');

            actualizarFiltroSucursales('all');

            blockFilter.addEventListener('change', function () {
                actualizarFiltroSucursales(this.value);
                filtrarVistaActual();
            });

            ['branchFilter', 'permisoFilter', 'estatusFilter'].forEach(id => {
                document.getElementById(id)?.addEventListener('change', filtrarVistaActual);
            });

            document.getElementById('busquedaInput')?.addEventListener('input', filtrarVistaActual);
        }

        function actualizarFiltroSucursales(blockValue) {
            const branchFilter = document.getElementById('branchFilter');
            branchFilter.innerHTML = '<option value="all">Todas las Sucursales</option>';

            let sucursales = [];
            if (blockValue === 'all') {
                sucursales = [...new Set(branchData.map(b => b.name))].sort();
            } else {
                sucursales = branchData.filter(b => b.block === blockValue)
                    .sort((a, b) => a.name.localeCompare(b.name))
                    .map(b => b.name);
            }

            sucursales.forEach(sucursal => {
                const option = document.createElement('option');
                option.value = sucursal;
                option.textContent = sucursal;
                branchFilter.appendChild(option);
            });
        }

        function filtrarVistaActual() {
            const blockFilter = document.getElementById('blockFilter').value;
            const branchFilter = document.getElementById('branchFilter').value;
            const permisoFilter = document.getElementById('permisoFilter').value;
            const estatusFilter = document.getElementById('estatusFilter').value;
            const busqueda = document.getElementById('busquedaInput').value.toLowerCase();

            let filtrados = [...permisosGuardados];

            if (blockFilter !== 'all') filtrados = filtrados.filter(p => p.bloque === blockFilter);
            if (branchFilter !== 'all') filtrados = filtrados.filter(p => p.sucursal === branchFilter);
            if (permisoFilter !== 'all') filtrados = filtrados.filter(p => p.permiso === permisoFilter);
            if (estatusFilter !== 'all') filtrados = filtrados.filter(p => p.estatus === estatusFilter);
            if (busqueda) {
                filtrados = filtrados.filter(p =>
                    (p.sucursal && p.sucursal.toLowerCase().includes(busqueda)) ||
                    (p.permiso && p.permiso.toLowerCase().includes(busqueda)) ||
                    (p.existencia && p.existencia.toLowerCase().includes(busqueda)) ||
                    (p.estatusLegal && p.estatusLegal.toLowerCase().includes(busqueda))
                );
            }

            if (currentView === 'tabla') {
                mostrarRegistrosEnTabla(filtrados);
            } else {
                mostrarKanban(filtrados);
            }
        }

        // MODAL DE REPORTES - FUNCIONES COMPLETAS
        function generarReporte(estatus) {
            console.log(`Generando reporte en modal para: ${estatus}`);
            reporteActual = estatus;

            // Mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById('reporteModal'));
            modal.show();

            // Cargar los datos del reporte
            cargarDatosReporte(estatus);
        }

        function cargarDatosReporte(tipoReporte) {
            let permisosFiltrados = [];

            switch (tipoReporte) {
                case 'vigentes':
                    permisosFiltrados = permisosGuardados.filter(p => p.estatus === 'vigente');
                    break;
                case 'vencidos':
                    permisosFiltrados = permisosGuardados.filter(p => p.estatus === 'vencido');
                    break;
                case 'en-tramite':
                    permisosFiltrados = permisosGuardados.filter(p => p.estatus === 'en-tramite');
                    break;
                case 'pendientes':
                    permisosFiltrados = permisosGuardados.filter(p => !p.estatus || p.estatus === 'pendiente');
                    break;
                case 'proximos-a-vencer':
                    permisosFiltrados = permisosGuardados.filter(p => p.estatus === 'proximo-a-vencer');
                    break;
                case 'todos':
                default:
                    permisosFiltrados = permisosGuardados;
            }

            // Generar el HTML del reporte
            generarHTMLReporte(permisosFiltrados, tipoReporte);
        }

        function generarHTMLReporte(permisos, tipo) {
            const modalContent = document.querySelector('#reporteModal .modal-content');
            const nombreReporte = obtenerNombreReporte(tipo);

            // Determinar si hay permisos para mostrar botones
            const tienePermisos = permisos.length > 0;

            modalContent.innerHTML = `
                <div class="modal-header">
                    <h5 class="modal-title" id="reporteModalLabel">
                        <i class="fas fa-file-alt me-2"></i>
                        REPORTE DE PERMISOS - ${nombreReporte.toUpperCase()}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <span class="badge bg-secondary me-2">Total: ${permisos.length}</span>
                            <span class="badge bg-success me-2">Vigentes: ${permisos.filter(p => p.estatus === 'vigente').length}</span>
                            <span class="badge bg-danger">Vencidos: ${permisos.filter(p => p.estatus === 'vencido').length}</span>
                        </div>
                        <div class="text-muted small">
                            ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-dark table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>BLOQUE</th>
                                    <th>SUCURSAL</th>
                                    <th>PERMISO</th>
                                    <th>EXISTENCIA</th>
                                    <th>FECHA EXP.</th>
                                    <th>FECHA REN.</th>
                                    <th>ESTATUS</th>
                                    <th>ESTATUS LEGAL</th>
                                </tr>
                            </thead>
                            <tbody id="tablaReporteBody">
                                ${generarFilasReporte(permisos)}
                            </tbody>
                        </table>
                    </div>
                    
                    ${permisos.length === 0 ?
                    '<div class="alert alert-warning text-center"><i class="fas fa-exclamation-triangle me-2"></i>No hay registros para mostrar en este reporte.</div>' :
                    ''
                }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cerrar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="imprimirReporte()" ${!tienePermisos ? 'disabled' : ''}>
                        <i class="fas fa-print me-1"></i> Imprimir
                    </button>
                    <button type="button" class="btn btn-success" onclick="exportarReporteACSV()" ${!tienePermisos ? 'disabled' : ''}>
                        <i class="fas fa-download me-1"></i> Exportar CSV
                    </button>
                </div>
            `;

            console.log(`Reporte generado: ${permisos.length} registros, bot√≥n imprimir: ${tienePermisos ? 'ACTIVO' : 'DESACTIVADO'}`);
        }

        function generarFilasReporte(permisos) {
            if (permisos.length === 0) {
                return '<tr><td colspan="9" class="text-center py-4"><i class="fas fa-inbox fa-2x text-muted mb-2"></i><p class="text-muted">No hay datos para mostrar</p></td></tr>';
            }

            return permisos.map((permiso, index) => {
                const colorEstatus = getColorEstatusBadge(permiso.estatus);
                const textoEstatus = getTextoEstatus(permiso.estatus);

                return `<tr>
                    <td class="text-center">${index + 1}</td>
                    <td>${permiso.bloque || 'N/A'}</td>
                    <td><strong>${permiso.sucursal || 'Sin sucursal'}</strong></td>
                    <td>${permiso.permiso || 'Sin permiso'}</td>
                    <td>${permiso.existencia || 'N/A'}</td>
                    <td>${permiso.fechaExpedicion || 'N/A'}</td>
                    <td>${permiso.fechaRenovacion || 'N/A'}</td>
                    <td><span class="badge ${colorEstatus}">${textoEstatus}</span></td>
                    <td>${permiso.estatusLegal || 'N/A'}</td>
                </tr>`;
            }).join('');
        }

        function imprimirReporte() {
            if (!reporteActual) {
                alert('No hay reporte actual para imprimir');
                return;
            }

            const permisos = permisosGuardados.filter(p => filtrarPorReporte(p, reporteActual));

            if (permisos.length === 0) {
                alert('No hay datos para imprimir');
                return;
            }

            const rowsHtml = permisos.map((permiso, index) => {
                const textoEstatus = getTextoEstatus(permiso.estatus);

                return `
      <tr>
        <td class="c">${index + 1}</td>
        <td class="c">${permiso.bloque || 'N/A'}</td>
        <td><strong>${permiso.sucursal || 'Sin sucursal'}</strong></td>
        <td>${permiso.permiso || 'Sin permiso'}</td>
        <td>${permiso.existencia || 'N/A'}</td>
        <td class="c">${permiso.fechaExpedicion || 'N/A'}</td>
        <td class="c">${permiso.fechaRenovacion || 'N/A'}</td>
        <td class="c"><span class="badge b-${permiso.estatus || 'pendiente'}">${textoEstatus}</span></td>
        <td>${permiso.estatusLegal || 'N/A'}</td>
      </tr>
    `;
            }).join('');

            const titulo = `Reporte de Permisos - ${obtenerNombreReporte(reporteActual)}`;
            const fecha = new Date().toLocaleString('es-MX');

            const total = permisos.length;
            const vigentes = permisos.filter(p => p.estatus === 'vigente').length;
            const vencidos = permisos.filter(p => p.estatus === 'vencido').length;
            const tramite = permisos.filter(p => p.estatus === 'en-tramite').length;
            const pendientes = permisos.filter(p => !p.estatus || p.estatus === 'pendiente').length;
            const proximos = permisos.filter(p => p.estatus === 'proximo-a-vencer').length;

            const printWindow = window.open('', '_blank', 'width=1100,height=800');
            if (!printWindow) {
                alert('Tu navegador bloque√≥ la ventana de impresi√≥n. Permite pop-ups para este sitio.');
                return;
            }

            const generadoPor = (document.getElementById('nombreUsuario')?.textContent || '').trim() || 'Sistema';
            const departamento = 'Gestion Juridica';

            const filtroAplicado = (() => {
                switch (reporteActual) {
                    case 'vigentes': return 'Vigente';
                    case 'vencidos': return 'Vencido';
                    case 'en-tramite': return 'En tr√°mite';
                    case 'pendientes': return 'Pendiente';
                    case 'proximos-a-vencer': return 'Pr√≥ximo a vencer';
                    case 'todos': return 'Todos';
                    default: return 'Todos';
                }
            })();

            printWindow.document.open();
            printWindow.document.write(`
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>${titulo}</title>
  <style>
    @page { size: letter; margin: 12mm; } /* Cambia a A4 si quieres */
    body{
      font-family: Arial, sans-serif;
      color:#111;
      background:#fff;
      margin:0;
    }

    .header{
      border-bottom: 3px solid #b71c1c;
      padding: 0 0 10px 0;
      margin-bottom: 12px;
    }
    .brand{
      font-size: 18px;
      font-weight: 700;
      letter-spacing: .5px;
      color:#b71c1c;
      margin:0;
    }
    .title{
      font-size: 14px;
      font-weight: 700;
      margin: 6px 0 0 0;
      color:#111;
    }
    .meta{
      font-size: 11px;
      color:#555;
      margin-top: 4px;
    }

    .stats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin: 10px 0 14px 0;
    }
    .stat{
      border:1px solid #ddd;
      border-radius: 8px;
      padding: 8px 10px;
      min-width: 140px;
      background:#fafafa;
    }
    .stat .n{
      font-size: 16px;
      font-weight: 700;
      color:#b71c1c;
      line-height: 1.1;
    }
    .stat .l{
      font-size: 10px;
      color:#666;
      letter-spacing: .8px;
      text-transform: uppercase;
    }

    table{
      width:100%;
      border-collapse: collapse;
      font-size: 10.5px;
    }
    thead{
      display: table-header-group; /* Repite encabezado por p√°gina */
    }
    th, td{
      border:1px solid #ddd;
      padding: 6px 6px;
      vertical-align: middle;
    }
    th{
      background:#f1f1f1;
      text-transform: uppercase;
      font-size: 10px;
      letter-spacing: .6px;
    }
    tr:nth-child(even) td{
      background:#fcfcfc;
    }
    .c{ text-align:center; white-space:nowrap; }

    /* badges */
    .badge{
      display:inline-block;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 9px;
      font-weight: 700;
      letter-spacing: .4px;
      border: 1px solid rgba(0,0,0,.12);
    }
    .b-vigente{ background:#e9f7ef; color:#1e7e34; }
    .b-en-tramite{ background:#e8f4fd; color:#0b7285; }
    .b-vencido{ background:#fdeaea; color:#c92a2a; }
    .b-pendiente{ background:#f3f3f3; color:#444; }
    .b-proximo-a-vencer{ background:#fff3cd; color:#8a6d3b; }

    /* Evitar cortes feos */
    tr{ page-break-inside: avoid; }
    .footer{
      margin-top: 14px;
      font-size: 10px;
      color:#666;
      border-top: 1px solid #ddd;
      padding-top: 8px;
      text-align:center;
    }

    /* Oculta cualquier cosa no imprimible */
    @media print{
      .no-print{ display:none !important; }
    }
  </style>
</head>
<body>
  <div class="header">
  <p class="brand">Reporte de Permisos - La Postal</p>
  <p class="title">${filtroAplicado}</p>
  <div class="meta">Fecha de generaci√≥n: ${fecha}</div>
</div>

<div class="meta" style="margin: 12px 0 14px 0;">
  <div><strong>Filtro aplicado:</strong> ${filtroAplicado}</div>
  <div><strong>Total de registros:</strong> ${total}</div>
  <div><strong>Generado por:</strong> ${generadoPor}</div>
  <div><strong>Departamento:</strong> ${departamento}</div>
</div>

</div>

  <div class="stats">
    <div class="stat"><div class="n">${total}</div><div class="l">Total</div></div>
    <div class="stat"><div class="n">${vigentes}</div><div class="l">Vigentes</div></div>
    <div class="stat"><div class="n">${proximos}</div><div class="l">Pr√≥ximos</div></div>
    <div class="stat"><div class="n">${tramite}</div><div class="l">En tr√°mite</div></div>
    <div class="stat"><div class="n">${pendientes}</div><div class="l">Pendientes</div></div>
    <div class="stat"><div class="n">${vencidos}</div><div class="l">Vencidos</div></div>
  </div>

  <table>
    <thead>
      <tr>
        <th style="width:30px;">#</th>
        <th style="width:55px;">Bloque</th>
        <th>Sucursal</th>
        <th>Permiso</th>
        <th>Existencia</th>
        <th style="width:92px;">Fecha Exp.</th>
        <th style="width:92px;">Fecha Ren.</th>
        <th style="width:95px;">Estatus</th>
        <th>Estatus Legal</th>
      </tr>
    </thead>
    <tbody>
      ${rowsHtml}
    </tbody>
  </table>

<div class="meta" style="margin-top: 10px; text-align: right;">
  <strong>Total de permisos:</strong> ${total}
</div>

  <div class="footer">
  Sistema de Gesti√≥n de Permisos - La Postal ¬© 2026<br>
  Este reporte fue generado autom√°ticamente por el sistema.
</div>


  <script>
    window.onload = function () {
      window.focus();
      window.print();
      window.onafterprint = function () { window.close(); };
    };
  <\/script>

</body>

</html>
`);
            printWindow.document.close();
        }

        function exportarReporteACSV() {
            if (!reporteActual) {
                alert('No hay reporte actual para exportar');
                return;
            }

            const permisos = permisosGuardados.filter(p => filtrarPorReporte(p, reporteActual));

            if (permisos.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            // Crear cabeceras CSV
            let csvContent = "BLOQUE,SUCURSAL,PERMISO,EXISTENCIA,ESTATUS,FECHA EXPEDICION,FECHA RENOVACION,ESTATUS LEGAL\\n";

            // Agregar datos
            permisos.forEach(permiso => {
                const fila = [
                    `"${permiso.bloque || ''}"`,
                    `"${permiso.sucursal || ''}"`,
                    `"${permiso.permiso || ''}"`,
                    `"${permiso.existencia || ''}"`,
                    `"${getTextoEstatus(permiso.estatus)}"`,
                    `"${permiso.fechaExpedicion || ''}"`,
                    `"${permiso.fechaRenovacion || ''}"`,
                    `"${permiso.estatusLegal || ''}"`
                ];
                csvContent += fila.join(',') + "\\n";
            });

            // Crear enlace de descarga
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', `reporte_${reporteActual}_${new Date().toISOString().slice(0, 10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert(`Reporte exportado: ${permisos.length} registros`);
        }

        // Funciones auxiliares
        function filtrarPorReporte(permiso, tipo) {
            switch (tipo) {
                case 'vigentes': return permiso.estatus === 'vigente';
                case 'vencidos': return permiso.estatus === 'vencido';
                case 'en-tramite': return permiso.estatus === 'en-tramite';
                case 'pendientes': return !permiso.estatus || permiso.estatus === 'pendiente';
                case 'proximos-a-vencer': return permiso.estatus === 'proximo-a-vencer';
                case 'todos': return true;
                default: return true;
            }
        }

        function obtenerNombreReporte(tipo) {
            const nombres = {
                'vigentes': 'Permisos Vigentes',
                'vencidos': 'Permisos Vencidos',
                'en-tramite': 'Permisos en Tr√°mite',
                'pendientes': 'Permisos Pendientes',
                'proximos-a-vencer': 'Permisos Pr√≥ximos a Vencer',
                'todos': 'Todos los Permisos'
            };
            return nombres[tipo] || tipo;
        }

        function getColorEstatusBadge(estatus) {
            switch (estatus) {
                case 'vigente': return 'bg-success';
                case 'en-tramite': return 'bg-info';
                case 'vencido': return 'bg-danger';
                case 'pendiente': return 'bg-secondary';
                case 'proximo-a-vencer': return 'bg-warning';
                default: return 'bg-secondary';
            }
        }

        function getTextoEstatus(estatus) {
            switch (estatus) {
                case 'vigente': return 'VIGENTE';
                case 'en-tramite': return 'EN TR√ÅMITE';
                case 'vencido': return 'VENCIDO';
                case 'pendiente': return 'PENDIENTE';
                case 'proximo-a-vencer': return 'PR√ìXIMO A VENCER';
                default: return estatus?.toUpperCase() || 'PENDIENTE';
            }
        }

        // FUNCI√ìN PARA CALCULAR ESTATUS AUTOM√ÅTICO BASADO EN FECHAS
        function calcularEstatusAutomatico(fechaRenovacion, estatusActual) {
            if (!fechaRenovacion) return estatusActual || 'pendiente';

            const hoy = new Date();
            const fechaVen = new Date(fechaRenovacion);

            // Si ya pas√≥ la fecha de renovaci√≥n
            if (fechaVen < hoy) return 'vencido';

            // Calcular d√≠as faltantes
            const diffTime = fechaVen - hoy;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // Si faltan 7 d√≠as o menos
            if (diffDays <= 7) return 'proximo-a-vencer';

            // Si est√° vigente pero no pr√≥ximo a vencer
            return estatusActual === 'vigente' ? 'vigente' : (estatusActual || 'pendiente');
        }

        // FUNCI√ìN PARA ACTUALIZAR ESTATUS DE TODOS LOS REGISTROS
        async function actualizarEstatusAutomaticamente() {
            console.log('üîÑ Actualizando estatus autom√°ticamente...');

            const cambios = [];
            const hoy = new Date();

            // Recorrer todos los permisos y calcular nuevo estatus
            for (let i = 0; i < permisosGuardados.length; i++) {
                const permiso = permisosGuardados[i];
                if (!permiso.fechaRenovacion) continue;

                const fechaVen = new Date(permiso.fechaRenovacion);
                const diffTime = fechaVen - hoy;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                let nuevoEstatus = permiso.estatus;

                // REGLA 1: Si ya venci√≥
                if (fechaVen < hoy && permiso.estatus !== 'vencido') {
                    nuevoEstatus = 'vencido';
                }
                // REGLA 2: Si faltan 7 d√≠as o menos
                else if (diffDays <= 7 && diffDays > 0 && permiso.estatus !== 'proximo-a-vencer') {
                    nuevoEstatus = 'proximo-a-vencer';
                }
                // REGLA 3: Si ya no est√° pr√≥ximo a vencer (pasaron los 7 d√≠as)
                else if (permiso.estatus === 'proximo-a-vencer' && diffDays > 7) {
                    nuevoEstatus = 'vigente';
                }

                // Si cambi√≥ el estatus
                if (nuevoEstatus !== permiso.estatus) {
                    cambios.push({
                        id: permiso.id,
                        index: i,
                        anterior: permiso.estatus,
                        nuevo: nuevoEstatus,
                        sucursal: permiso.sucursal,
                        dias: diffDays
                    });

                    permisosGuardados[i].estatus = nuevoEstatus;

                    // Actualizar en Supabase
                    try {
                        const { error } = await supabaseClient
                            .from('datos_financieros')
                            .update({
                                estatus: nuevoEstatus,
                                actualizado_en: new Date().toISOString()
                            })
                            .eq('id', permiso.id);

                        if (error) {
                            console.error(`‚ùå Error actualizando ${permiso.sucursal}:`, error);
                        }
                    } catch (error) {
                        console.error(`‚ùå Error Supabase para ${permiso.sucursal}:`, error);
                    }
                }
            }

            // Guardar en localStorage
            localStorage.setItem('permisos', JSON.stringify(permisosGuardados));

            // Refrescar vista
            if (cambios.length > 0) {
                if (currentView === 'tabla') mostrarRegistrosEnTabla(permisosGuardados);
                else mostrarKanban(permisosGuardados);
                actualizarContadores();
            }

            return cambios.length;
        }

        // FUNCI√ìN PARA CALCULAR ESTATUS AL GUARDAR (antes de enviar a Supabase)
        function calcularEstatusAlGuardar(fechaRenovacion, estatusSeleccionado) {
            // Si NO hay fecha, respeta lo que el usuario eligi√≥ en el modal
            if (!fechaRenovacion) return estatusSeleccionado || 'pendiente';

            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);

            const fechaVen = new Date(fechaRenovacion);
            fechaVen.setHours(0, 0, 0, 0);

            const diffDays = Math.ceil((fechaVen - hoy) / (1000 * 60 * 60 * 24));

            if (diffDays < 0) return 'vencido';
            if (diffDays <= 7) return 'proximo-a-vencer';
            return 'vigente';
        }


        document.addEventListener('DOMContentLoaded', async function () {
            console.log('üöÄ Iniciando aplicaci√≥n...');

            await cargarDatosIniciales();
            inicializarFiltros();

            // Actualizar estatus autom√°ticamente despu√©s de cargar
            setTimeout(() => {
                actualizarEstatusAutomaticamente();
            }, 2000);

            // Actualizar estatus cada hora
            setInterval(() => {
                actualizarEstatusAutomaticamente();
            }, 60 * 60 * 1000);
        });


        // Eventos de vista
        document.getElementById('btnVistaTabla').addEventListener('click', () => cambiarVista('tabla'));
        document.getElementById('btnVistaKanban').addEventListener('click', () => cambiarVista('kanban'));

        // Eventos de modal principal
        document.getElementById('btnAgregar').addEventListener('click', () => abrirModal());
        document.getElementById('cancelarModal').addEventListener('click', cerrarModal);
        document.getElementById('guardarRegistro').addEventListener('click', guardarPermiso);

        document.getElementById('modalAgregar').addEventListener('click', function (e) {
            if (e.target === this) cerrarModal();
        });

        // Eventos de formulario
        document.getElementById('bloqueModal').addEventListener('change', cargarSucursalesModal);

        document.getElementById('permisoDigital').addEventListener('change', function () {
            const fileInfo = document.getElementById('fileInfo');
            if (this.files.length > 0) {
                const file = this.files[0];
                const fileSize = (file.size / 1024).toFixed(2);
                fileInfo.innerHTML = `<i class="fas ${getFileIcon(file.name)}"></i> ${file.name} (${fileSize} KB)`;
            } else {
                fileInfo.innerHTML = '';
            }
        });

        // Eventos modal detalle
        document.getElementById('modalDetalle').addEventListener('click', function (e) {
            if (e.target === this) cerrarDetalleModal();
        });

        // Eventos modal reporte
        const reporteModal = document.getElementById('reporteModal');
        if (reporteModal) {
            reporteModal.addEventListener('hidden.bs.modal', function () {
                // Limpiar el contenido cuando se cierra
                const modalContent = this.querySelector('.modal-content');
                modalContent.innerHTML = `
        <div class="text-center py-5" id="modalLoading">
            <div class="spinner-border text-danger" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-3">Generando reporte...</p>
        </div>
        `;
                reporteActual = '';
            });
        }

        console.log('‚úÖ Aplicaci√≥n inicializada correctamente');

    </script>
</body>

</html>